<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Billion Number Challenge</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --error: #dc2626;
            --bg: #f8fafc;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
            box-sizing: border-box;
        }
        h1 { 
            margin-top: 0; 
            color: #333;
            font-size: 1.8rem;
        }
        
        .number-display {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--primary);
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
            word-break: break-all;
            line-height: 1.2;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: all 0.2s;
            min-height: 44px; /* è§¦æ‘¸å‹å¥½çš„æœ€å°å°ºå¯¸ */
            touch-action: manipulation; /* ä¼˜åŒ–è§¦æ‘¸å“åº” */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-outline { border: 2px solid #cbd5e1; background: transparent; }
        
        .status-bar {
            height: 30px;
            margin: 10px 0;
            font-weight: bold;
            color: #64748b;
        }

        .timer-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .feedback-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f1f5f9;
            text-align: left;
            display: none;
        }
        .feedback-correct { border-left: 5px solid var(--success); }
        .feedback-wrong { border-left: 5px solid var(--error); }

        .settings {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 0.9rem;
            color: #666;
        }
        input[type="range"] { vertical-align: middle; }
        
        .custom-number-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .custom-number-input {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        .custom-number-input input {
            padding: 8px 12px;
            border: 2px solid #cbd5e1;
            border-radius: 5px;
            font-size: 0.9rem;
            width: 150px;
            text-align: center;
        }
        .custom-number-input input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .custom-number-input button {
            padding: 8px 16px;
            font-size: 0.85rem;
        }
        .input-error {
            color: var(--error);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
        .input-error.show {
            display: block;
        }

        /* å†å²è®°å½•æ ·å¼ */
        .history-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: none;
        }
        .history-section.show {
            display: block;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #666;
        }
        .history-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .history-item {
            padding: 8px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
            transition: all 0.2s;
            word-break: break-all;
        }
        .history-item:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        .history-item.correct {
            border-left: 4px solid var(--success);
        }
        .history-item.wrong {
            border-left: 4px solid var(--error);
            background: #fef2f2;
        }
        .history-item.wrong:hover {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }
        .history-item {
            min-height: 44px; /* è§¦æ‘¸å‹å¥½çš„æœ€å°å°ºå¯¸ */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .history-empty {
            text-align: center;
            color: #94a3b8;
            padding: 20px;
            font-size: 0.85rem;
        }

        /* å“åº”å¼è®¾è®¡ - å¹³æ¿ */
        @media screen and (max-width: 768px) {
            .container {
                padding: 1.5rem;
                margin: 10px;
            }
            h1 {
                font-size: 1.5rem;
            }
            .number-display {
                font-size: 2.8rem;
                margin: 15px 0;
            }
            .timer-circle {
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }
            .history-list {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                max-height: 180px;
            }
        }

        /* å“åº”å¼è®¾è®¡ - æ‰‹æœº */
        @media screen and (max-width: 480px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 1rem;
                border-radius: 0.75rem;
            }
            h1 {
                font-size: 1.3rem;
                margin-bottom: 10px;
            }
            .number-display {
                font-size: 2.2rem;
                margin: 15px 0;
            }
            .timer-circle {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
                margin-bottom: 15px;
            }
            .controls {
                flex-direction: column;
                gap: 8px;
            }
            button {
                width: 100%;
                padding: 14px 20px;
                font-size: 0.95rem;
            }
            .status-bar {
                font-size: 0.9rem;
                min-height: 24px;
            }
            .settings {
                font-size: 0.85rem;
            }
            .custom-number-section {
                margin-top: 10px;
                padding-top: 10px;
            }
            .custom-number-input {
                flex-direction: column;
            }
            .custom-number-input input {
                width: 100%;
                max-width: 200px;
            }
            .custom-number-input button {
                width: 100%;
                max-width: 200px;
            }
            .history-section {
                margin-top: 15px;
                padding-top: 15px;
            }
            .history-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .history-title {
                font-size: 0.85rem;
            }
            .history-list {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 6px;
                max-height: 150px;
                padding: 8px;
            }
            .history-item {
                padding: 10px 8px;
                font-size: 0.75rem;
            }
            .feedback-box {
                padding: 12px;
                font-size: 0.9rem;
            }
            .feedback-box h3 {
                font-size: 1rem;
                margin-top: 0;
            }
            .feedback-box p {
                font-size: 0.85rem;
                margin: 8px 0;
            }
            .feedback-box button {
                font-size: 0.8rem;
                padding: 10px 15px;
            }
            .toggle-history-btn {
                min-height: 40px;
                padding: 10px 15px;
                font-size: 0.85rem;
            }
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            body {
                padding: 10px;
            }
            .container {
                padding: 1rem;
            }
            .number-display {
                font-size: 2rem;
                margin: 10px 0;
            }
            .history-list {
                max-height: 120px;
            }
        }
        .toggle-history-btn {
            font-size: 0.8rem;
            padding: 8px 12px;
            background: transparent;
            border: 1px solid #cbd5e1;
            color: #64748b;
            cursor: pointer;
            border-radius: 4px;
            min-height: 36px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .toggle-history-btn:hover {
            background: #f1f5f9;
        }

        /* Animation for listening */
        .listening-pulse {
            animation: pulse 1.5s infinite;
            background-color: #ef4444;
            color: white;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”¢ Billion Number Challenge</h1>
    
    <div class="settings">
        <label>ç­‰å¾…æ—¶é—´: <span id="timeVal">5</span>s</label>
        <input type="range" id="waitRange" min="0" max="10" value="5" oninput="document.getElementById('timeVal').innerText = this.value">
    </div>

    <div class="custom-number-section">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">âœï¸ è‡ªå®šä¹‰æ•°å­—ç»ƒä¹ </label>
        <div class="custom-number-input">
            <input type="number" id="customNumberInput" placeholder="è¾“å…¥æ•°å­— (0-1,000,000,000)" min="0" max="1000000000" onkeypress="if(event.key==='Enter') startCustomRound()">
            <button class="btn-primary" onclick="startCustomRound()" id="customBtn">ç»ƒä¹ æ­¤æ•°å­—</button>
        </div>
        <div class="input-error" id="inputError"></div>
    </div>

    <div class="number-display" id="numberDisplay">---</div>
    
    <div class="timer-circle" id="timerDisplay">Wait</div>
    
    <div class="status-bar" id="statusText">ç‚¹å‡» "å¼€å§‹ç»ƒä¹ "</div>

    <div class="controls">
        <button class="btn-primary" onclick="startRound()" id="startBtn">å¼€å§‹ç»ƒä¹ </button>
        <button class="btn-outline" onclick="skipTimer()" id="skipBtn" disabled>ç›´æ¥è¯» (Skip)</button>
        <button class="btn-outline" onclick="toggleHistory()" id="historyToggleBtn">ğŸ“š å†å²è®°å½•</button>
        <button class="btn-outline" onclick="stopListening()" id="stopBtn" disabled style="display: none; background: var(--error); color: white; border-color: var(--error);">â¹ï¸ åœæ­¢å½•éŸ³</button>
    </div>

    <div class="feedback-box" id="feedbackArea">
        </div>

    <div class="history-section" id="historySection">
        <div class="history-header">
            <span class="history-title">ğŸ“š å†å²è®°å½• (æœ€è¿‘20ä¸ª)</span>
            <button class="toggle-history-btn" onclick="toggleHistory()">éšè—</button>
        </div>
        <div class="history-list" id="historyList">
            <div class="history-empty">æš‚æ— å†å²è®°å½•</div>
        </div>
    </div>
</div>

<script>
    // === æ ¸å¿ƒé€»è¾‘å˜é‡ ===
    let currentNumber = 0;
    let countdownInterval;
    let recognition = null; // è¯­éŸ³è¯†åˆ«å¯¹è±¡ï¼Œç§»åŠ¨ç«¯éœ€è¦é‡æ–°åˆ›å»º
    let isListening = false;
    let micPermissionGranted = false; // è·Ÿè¸ªéº¦å…‹é£æƒé™æ˜¯å¦å·²è·å–
    let historyNumbers = []; // å†å²è®°å½•æ•°ç»„ï¼Œæœ€å¤šä¿å­˜20ä¸ªæ•°å­—ï¼Œæ ¼å¼: {number: æ•°å­—, isCorrect: true/false/undefined}
    const MAX_HISTORY = 20; // æœ€å¤§å†å²è®°å½•æ•°
    let listeningTimeout = null; // è†å¬è¶…æ—¶å®šæ—¶å™¨
    const LISTENING_TIMEOUT = 15000; // 15ç§’è¶…æ—¶ï¼ˆç§»åŠ¨ç«¯å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
    let resultTimeout = null; // ç»“æœå¤„ç†å»¶è¿Ÿå®šæ—¶å™¨
    let pendingTranscript = null; // å¾…å¤„ç†çš„è¯†åˆ«ç»“æœ
    let lastResultTime = null; // æœ€åæ”¶åˆ°ç»“æœçš„æ—¶é—´

    // === æ•°å­—è½¬è‹±æ–‡é€»è¾‘ (æ ¸å¿ƒç®—æ³•) ===
    const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
    const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
    const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];

    function convertGroup(num) {
        let str = '';
        if (num >= 100) {
            str += ones[Math.floor(num / 100)] + ' hundred ';
            num %= 100;
            if (num > 0) str += 'and '; // UK style logic, simplified for normalized check
        }
        if (num >= 20) {
            str += tens[Math.floor(num / 10)] + ' ';
            num %= 10;
        }
        if (num >= 10) {
            str += teens[num - 10] + ' ';
            num = 0;
        }
        if (num > 0) {
            str += ones[num] + ' ';
        }
        return str.trim();
    }

    function numberToEnglish(num) {
        if (num === 0) return "zero";
        
        let str = '';
        
        // Billions
        let billions = Math.floor(num / 1000000000);
        if (billions > 0) str += convertGroup(billions) + ' billion ';
        num %= 1000000000;

        // Millions
        let millions = Math.floor(num / 1000000);
        if (millions > 0) str += convertGroup(millions) + ' million ';
        num %= 1000000;

        // Thousands
        let thousands = Math.floor(num / 1000);
        if (thousands > 0) str += convertGroup(thousands) + ' thousand ';
        num %= 1000;

        // Hundreds/Tens/Ones
        if (num > 0) {
             // Logic to add 'and' if preceding big numbers exist (Standard UK/Commonwealth, optional in US)
            if (str !== '' && num < 100) str += 'and '; 
            str += convertGroup(num);
        }
        
        return str.trim().replace(/\s+/g, ' ');
    }

    // === æ£€æµ‹ç§»åŠ¨è®¾å¤‡ ===
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               (window.innerWidth <= 768);
    }

    // === åˆ›å»ºè¯­éŸ³è¯†åˆ«å¯¹è±¡ ===
    function createRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const newRecognition = new SpeechRecognition();
            newRecognition.lang = 'en-US';
            
            // ç§»åŠ¨ç«¯ä½¿ç”¨å•æ¬¡è¯†åˆ«æ¨¡å¼ï¼Œæ¡Œé¢ç«¯ä½¿ç”¨æŒç»­æ¨¡å¼
            newRecognition.continuous = !isMobileDevice();
            // å¯ç”¨ä¸­é—´ç»“æœï¼Œå¸®åŠ©æ•è·çŸ­å•è¯
            newRecognition.interimResults = true;
            
            // ç§»åŠ¨ç«¯è®¾ç½®è¶…æ—¶ï¼ˆå¦‚æœæ”¯æŒï¼‰
            if (isMobileDevice() && newRecognition.maxAlternatives === undefined) {
                // æŸäº›ç§»åŠ¨ç«¯æµè§ˆå™¨å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
            }

            newRecognition.onstart = () => {
                isListening = true;
                micPermissionGranted = true;
                pendingTranscript = null;
                lastResultTime = null;
                document.getElementById('statusText').innerText = "ğŸ¤ æ­£åœ¨è†å¬...ï¼ˆè¯·æ¸…æ™°å‘éŸ³ï¼‰";
                document.getElementById('statusText').classList.add('listening-pulse');
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'inline-block';
                
                // è®¾ç½®è¶…æ—¶ï¼Œç§»åŠ¨ç«¯å¦‚æœé•¿æ—¶é—´æ²¡æœ‰ç»“æœå°±è‡ªåŠ¨åœæ­¢
                clearTimeout(listeningTimeout);
                clearTimeout(resultTimeout);
                listeningTimeout = setTimeout(() => {
                    if (isListening && recognition) {
                        console.log('Listening timeout, stopping recognition');
                        // å¦‚æœæœ‰å¾…å¤„ç†çš„ç»“æœï¼Œå…ˆå¤„ç†å®ƒ
                        if (pendingTranscript) {
                            processResult(pendingTranscript.transcript, pendingTranscript.confidence);
                        } else {
                            stopListening();
                            document.getElementById('statusText').innerText = "â±ï¸ è¶…æ—¶æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•";
                        }
                    }
                }, LISTENING_TIMEOUT);
            };

            newRecognition.onend = () => {
                isListening = false;
                clearTimeout(listeningTimeout);
                
                // å¦‚æœè¯†åˆ«ç»“æŸæ—¶è¿˜æœ‰å¾…å¤„ç†çš„ç»“æœï¼Œå¤„ç†å®ƒ
                if (pendingTranscript) {
                    clearTimeout(resultTimeout);
                    processResult(pendingTranscript.transcript, pendingTranscript.confidence);
                } else {
                    // æ²¡æœ‰ç»“æœï¼Œæ¢å¤æ­£å¸¸çŠ¶æ€
                    document.getElementById('statusText').classList.remove('listening-pulse');
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('stopBtn').style.display = 'none';
                }
                
                // ç§»åŠ¨ç«¯ï¼šè¯†åˆ«ç»“æŸåé‡æ–°åˆ›å»ºå¯¹è±¡ä»¥é¿å…abortedé”™è¯¯
                if (isMobileDevice()) {
                    recognition = null;
                }
            };

            newRecognition.onresult = (event) => {
                lastResultTime = Date.now();
                
                // å¤„ç†æ‰€æœ‰ç»“æœï¼ˆåŒ…æ‹¬ä¸­é—´ç»“æœå’Œæœ€ç»ˆç»“æœï¼‰
                let finalTranscript = '';
                let finalConfidence = 0.8;
                let hasFinalResult = false;
                
                for (let i = 0; i < event.results.length; i++) {
                    const result = event.results[i];
                    if (result.isFinal) {
                        hasFinalResult = true;
                        finalTranscript = result[0].transcript;
                        finalConfidence = result[0].confidence || 0.8;
                    } else {
                        // ä¸­é—´ç»“æœä¹Ÿä¿å­˜ï¼Œä»¥é˜²æœ€ç»ˆç»“æœä¸¢å¤±
                        if (!finalTranscript) {
                            finalTranscript = result[0].transcript;
                            finalConfidence = result[0].confidence || 0.8;
                        }
                    }
                }
                
                if (finalTranscript.trim()) {
                    // ä¿å­˜å¾…å¤„ç†çš„ç»“æœ
                    pendingTranscript = {
                        transcript: finalTranscript.trim(),
                        confidence: finalConfidence
                    };
                    
                    // å¦‚æœæ˜¯æœ€ç»ˆç»“æœï¼Œç«‹å³å¤„ç†
                    if (hasFinalResult) {
                        clearTimeout(resultTimeout);
                        processResult(pendingTranscript.transcript, pendingTranscript.confidence);
                    } else {
                        // å¯¹äºä¸­é—´ç»“æœï¼Œå»¶è¿Ÿå¤„ç†ï¼ˆç»™çŸ­å•è¯æ›´å¤šæ—¶é—´ï¼‰
                        clearTimeout(resultTimeout);
                        resultTimeout = setTimeout(() => {
                            if (pendingTranscript && isListening) {
                                // å¦‚æœ1ç§’å†…æ²¡æœ‰æ–°çš„ç»“æœï¼Œå¤„ç†å½“å‰ç»“æœ
                                const timeSinceLastResult = Date.now() - (lastResultTime || 0);
                                if (timeSinceLastResult >= 800) {
                                    processResult(pendingTranscript.transcript, pendingTranscript.confidence);
                                }
                            }
                        }, 1000); // 1ç§’å»¶è¿Ÿï¼Œç»™çŸ­å•è¯æ›´å¤šæ—¶é—´
                    }
                }
            };
            
            // å¤„ç†è¯†åˆ«ç»“æœçš„å‡½æ•°
            function processResult(transcript, confidence) {
                clearTimeout(listeningTimeout);
                clearTimeout(resultTimeout);
                pendingTranscript = null;
                
                // åœæ­¢è¯†åˆ«
                try {
                    if (recognition && isListening) {
                        recognition.stop();
                    }
                } catch (e) {
                    console.log('Error stopping recognition:', e);
                }
                
                // è¯„ä¼°ç­”æ¡ˆ
                evaluateAnswer(transcript, confidence);
            }

            newRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                
                // å¿½ç•¥æŸäº›å¯ä»¥å¿½ç•¥çš„é”™è¯¯
                if (event.error === 'aborted') {
                    // ç§»åŠ¨ç«¯abortedé”™è¯¯é€šå¸¸æ˜¯æ­£å¸¸çš„ï¼Œå¿½ç•¥å®ƒ
                    if (!isMobileDevice()) {
                        document.getElementById('statusText').innerText = "âš ï¸ è¯†åˆ«å·²ä¸­æ­¢";
                    }
                    isListening = false;
                    clearTimeout(listeningTimeout);
                    document.getElementById('statusText').classList.remove('listening-pulse');
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('stopBtn').style.display = 'none';
                    return;
                }
                
                if (event.error === 'no-speech') {
                    // æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³ï¼Œå¯ä»¥å¿½ç•¥æˆ–æç¤º
                    document.getElementById('statusText').innerText = "âš ï¸ æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•";
                    isListening = false;
                    clearTimeout(listeningTimeout);
                    document.getElementById('statusText').classList.remove('listening-pulse');
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('stopBtn').style.display = 'none';
                    return;
                }
                
                // å¦‚æœæ˜¯æƒé™é”™è¯¯ï¼Œé‡ç½®æ ‡å¿—
                if (event.error === 'not-allowed') {
                    micPermissionGranted = false;
                    document.getElementById('statusText').innerText = "âš ï¸ éœ€è¦éº¦å…‹é£æƒé™ï¼Œè¯·å…è®¸è®¿é—®";
                } else {
                    document.getElementById('statusText').innerText = "âš ï¸ è¯†åˆ«é”™è¯¯: " + event.error;
                }
                
                isListening = false;
                document.getElementById('statusText').classList.remove('listening-pulse');
                document.getElementById('startBtn').disabled = false;
                
                // ç§»åŠ¨ç«¯ï¼šå‡ºé”™åé‡æ–°åˆ›å»ºå¯¹è±¡
                if (isMobileDevice()) {
                    recognition = null;
                }
            };

            return newRecognition;
        }
        return null;
    }

    // === åˆå§‹åŒ–è¯­éŸ³è¯†åˆ« ===
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        recognition = createRecognition();
    } else {
        alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨ Google Chrome æˆ– Edgeã€‚");
    }

    // === æµç¨‹æ§åˆ¶ ===
    function generateRandomNumber() {
        // ä½¿ç”¨å¯¹æ•°åˆ†å¸ƒï¼Œè®©ä¸åŒæ•°é‡çº§çš„æ•°å­—å‡ºç°æ¦‚ç‡æ›´å‡åŒ€
        // ç”Ÿæˆ 0 åˆ° 1,000,000,000 çš„æ•°å­—
        const max = 1000000000;
        // ä½¿ç”¨å¯¹æ•°éšæœºï¼Œè®©0-100, 100-1000, 1000-10000ç­‰å„æ•°é‡çº§å‡ºç°æ¦‚ç‡ç›¸è¿‘
        const logMax = Math.log10(max + 1);
        const randomLog = Math.random() * logMax;
        const number = Math.floor(Math.pow(10, randomLog));
        return number;
    }

    function formatNumber(num) {
        return num.toLocaleString('en-US'); // æ˜¾ç¤ºåƒåˆ†ä½
    }

    function startRound() {
        resetUI();
        currentNumber = generateRandomNumber();
        addToHistory(currentNumber, undefined); // æ·»åŠ åˆ°å†å²è®°å½•ï¼Œç»“æœæœªçŸ¥
        document.getElementById('numberDisplay').innerText = formatNumber(currentNumber);
        
        const waitTime = parseInt(document.getElementById('waitRange').value);
        
        if (waitTime > 0) {
            let timeLeft = waitTime;
            document.getElementById('timerDisplay').innerText = timeLeft;
            document.getElementById('skipBtn').disabled = false;
            document.getElementById('statusText').innerText = "è¯·åœ¨å€’è®¡æ—¶ç»“æŸåæœ—è¯»...";
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    activateListening();
                }
            }, 1000);
        } else {
            activateListening();
        }
    }

    function startCustomRound() {
        const input = document.getElementById('customNumberInput');
        const errorDiv = document.getElementById('inputError');
        const inputValue = input.value.trim();
        
        // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯æç¤º
        errorDiv.classList.remove('show');
        errorDiv.innerText = '';
        
        // éªŒè¯è¾“å…¥
        if (!inputValue) {
            errorDiv.innerText = 'è¯·è¾“å…¥ä¸€ä¸ªæ•°å­—';
            errorDiv.classList.add('show');
            input.focus();
            return;
        }
        
        const number = parseInt(inputValue);
        
        // éªŒè¯æ•°å­—èŒƒå›´
        if (isNaN(number)) {
            errorDiv.innerText = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—';
            errorDiv.classList.add('show');
            input.focus();
            return;
        }
        
        if (number < 0) {
            errorDiv.innerText = 'æ•°å­—ä¸èƒ½å°äº0';
            errorDiv.classList.add('show');
            input.focus();
            return;
        }
        
        if (number > 1000000000) {
            errorDiv.innerText = 'æ•°å­—ä¸èƒ½å¤§äº1,000,000,000';
            errorDiv.classList.add('show');
            input.focus();
            return;
        }
        
        // éªŒè¯é€šè¿‡ï¼Œå¼€å§‹ç»ƒä¹ 
        resetUI();
        currentNumber = number;
        addToHistory(currentNumber, undefined); // æ·»åŠ åˆ°å†å²è®°å½•
        document.getElementById('numberDisplay').innerText = formatNumber(currentNumber);
        
        const waitTime = parseInt(document.getElementById('waitRange').value);
        
        if (waitTime > 0) {
            let timeLeft = waitTime;
            document.getElementById('timerDisplay').innerText = timeLeft;
            document.getElementById('skipBtn').disabled = false;
            document.getElementById('statusText').innerText = "è¯·åœ¨å€’è®¡æ—¶ç»“æŸåæœ—è¯»...";
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    activateListening();
                }
            }, 1000);
        } else {
            activateListening();
        }
        
        // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä»¥ä¿ç•™ï¼‰
        // input.value = '';
    }

    function startRoundWithNumber(number) {
        // ä»å†å²è®°å½•é€‰æ‹©æ•°å­—å¼€å§‹ç»ƒä¹ 
        resetUI();
        currentNumber = number;
        document.getElementById('numberDisplay').innerText = formatNumber(currentNumber);
        
        const waitTime = parseInt(document.getElementById('waitRange').value);
        
        if (waitTime > 0) {
            let timeLeft = waitTime;
            document.getElementById('timerDisplay').innerText = timeLeft;
            document.getElementById('skipBtn').disabled = false;
            document.getElementById('statusText').innerText = "è¯·åœ¨å€’è®¡æ—¶ç»“æŸåæœ—è¯»...";
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    activateListening();
                }
            }, 1000);
        } else {
            activateListening();
        }
    }

    function retryRound() {
        // é‡è¯»å½“å‰æ•°å­—ï¼Œä¸ç”Ÿæˆæ–°æ•°å­—
        resetUI();
        // currentNumber ä¿æŒä¸å˜ï¼Œåªé‡ç½®UIå¹¶é‡æ–°å¼€å§‹å€’è®¡æ—¶
        
        const waitTime = parseInt(document.getElementById('waitRange').value);
        
        if (waitTime > 0) {
            let timeLeft = waitTime;
            document.getElementById('timerDisplay').innerText = timeLeft;
            document.getElementById('skipBtn').disabled = false;
            document.getElementById('statusText').innerText = "è¯·åœ¨å€’è®¡æ—¶ç»“æŸåé‡æ–°æœ—è¯»...";
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    activateListening();
                }
            }, 1000);
        } else {
            activateListening();
        }
    }

    function skipTimer() {
        clearInterval(countdownInterval);
        document.getElementById('timerDisplay').innerText = "Go";
        activateListening();
    }

    function activateListening() {
        document.getElementById('skipBtn').disabled = true;
        document.getElementById('timerDisplay').innerText = "ğŸ¤";
        
        // ç§»åŠ¨ç«¯ï¼šå¦‚æœè¯†åˆ«å¯¹è±¡ä¸å­˜åœ¨æˆ–å·²å¤±æ•ˆï¼Œé‡æ–°åˆ›å»º
        if (isMobileDevice() && (!recognition || recognition === null)) {
            recognition = createRecognition();
        }
        
        if (!recognition) {
            document.getElementById('statusText').innerText = "âš ï¸ è¯­éŸ³è¯†åˆ«ä¸å¯ç”¨";
            return;
        }
        
        try {
            // å¦‚æœè¯†åˆ«å·²ç»åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢å†å¯åŠ¨
            if (isListening) {
                recognition.stop();
                // ç­‰å¾…åœæ­¢åå†å¯åŠ¨
                setTimeout(() => {
                    if (isMobileDevice() && (!recognition || recognition === null)) {
                        recognition = createRecognition();
                    }
                    if (recognition) {
                        recognition.start();
                    }
                }, 200);
            } else {
                recognition.start();
            }
        } catch (e) {
            console.error('Error starting recognition:', e);
            // å¦‚æœè¯†åˆ«å·²ç»åœ¨è¿è¡Œï¼Œå°è¯•åœæ­¢åé‡æ–°å¯åŠ¨
            if (e.name === 'InvalidStateError') {
                try {
                    recognition.stop();
                } catch (stopError) {
                    console.error('Error stopping recognition:', stopError);
                }
                setTimeout(() => {
                    // ç§»åŠ¨ç«¯ï¼šé‡æ–°åˆ›å»ºè¯†åˆ«å¯¹è±¡
                    if (isMobileDevice()) {
                        recognition = createRecognition();
                    }
                    if (recognition) {
                        try {
                            recognition.start();
                        } catch (e2) {
                            console.error('Error restarting recognition:', e2);
                            document.getElementById('statusText').innerText = "âš ï¸ æ— æ³•å¯åŠ¨è¯­éŸ³è¯†åˆ«ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•";
                            document.getElementById('startBtn').disabled = false;
                        }
                    }
                }, 200);
            } else {
                document.getElementById('statusText').innerText = "âš ï¸ å¯åŠ¨è¯†åˆ«å¤±è´¥: " + e.message;
                document.getElementById('startBtn').disabled = false;
            }
        }
    }

    // === åˆ¤å®šä¸åé¦ˆé€»è¾‘ ===
    function evaluateAnswer(userSpeech, confidence) {
        const standardRead = numberToEnglish(currentNumber).toLowerCase();
        const userRead = userSpeech.toLowerCase(); // ç”¨æˆ·è¯»çš„
        
        // ç®€å•çš„æ•°æ®æ¸…æ´—ï¼šç§»é™¤æ ‡ç‚¹ï¼Œå°†æ•°å­—å­—ç¬¦è½¬ä¸ºå•è¯ï¼ˆå¦‚æœè¯†åˆ«å¼•æ“è¾“å‡ºäº† "123" è€Œä¸æ˜¯ "one hundred..."ï¼‰
        // æ³¨æ„ï¼šWeb Speech API æœ‰æ—¶ä¼šç›´æ¥è¿”å›é˜¿æ‹‰ä¼¯æ•°å­—ï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºç®€åŒ–ï¼Œæˆ‘ä»¬ä¸»è¦æ¯”å¯¹æ–‡æœ¬ã€‚
        // å¦‚æœAPIè¿”å› "150"ï¼Œæˆ‘ä»¬éœ€è¦å®¹é”™ã€‚å®é™…ä¸ŠAPIåœ¨è‹±æ–‡æ¨¡å¼é€šå¸¸è¿”å› "one hundred fifty"ã€‚

        // æ ‡å‡†åŒ–å¤„ç†ï¼šç§»é™¤ "and", "-" ä»¥å…¼å®¹ä¸åŒå£éŸ³å’Œè¿è¯»
        const cleanStandard = standardRead.replace(/ and /g, ' ').replace(/-/g, ' ');
        const cleanUser = userRead.replace(/ and /g, ' ').replace(/-/g, ' ');

        // åˆ¤å®šé€»è¾‘
        let isCorrect = cleanUser.includes(cleanStandard);
        
        // é’ˆå¯¹APIå¯èƒ½è¿”å›é˜¿æ‹‰ä¼¯æ•°å­—çš„ç‰¹æ®Šå¤„ç† (å¦‚ç”¨æˆ·è¯´ "one hundred"ï¼ŒAPIè¿”å› "100")
        // è¿™ç§æƒ…å†µä¸‹ï¼Œç›´æ¥æ¯”å¯¹ currentNumber å’Œ userRead è½¬æ¢åçš„æ•°å­—
        // è¿™é‡Œåšä¸€ä¸ªç®€åŒ–çš„æ¨¡ç³ŠåŒ¹é…ï¼š
        if (!isCorrect) {
            // å°è¯•ç§»é™¤æ‰€æœ‰éæ•°å­—å­—ç¬¦ï¼Œçœ‹æ˜¯å¦ç­‰äºåŸæ•°å­—ï¼ˆé’ˆå¯¹APIè¿”å›é˜¿æ‹‰ä¼¯æ•°å­—çš„æƒ…å†µï¼‰
            const userNums = userRead.replace(/[^0-9]/g, '');
            if (userNums == currentNumber) isCorrect = true;
        }

        showFeedback(isCorrect, userRead, standardRead, confidence);
    }

    function showFeedback(isCorrect, userRead, standardRead, confidence) {
        const fbBox = document.getElementById('feedbackArea');
        fbBox.style.display = 'block';
        fbBox.className = 'feedback-box ' + (isCorrect ? 'feedback-correct' : 'feedback-wrong');

        let html = `<h3>${isCorrect ? 'âœ… è¯»æ³•æ­£ç¡®!' : 'âŒ éœ€è¦æ”¹è¿›'}</h3>`;
        html += `<p><strong>ä½ çš„å‘éŸ³è¯†åˆ«:</strong> "${userRead}"</p>`;
        
        // åªæœ‰é”™è¯¯æ—¶æ‰æ˜¾ç¤ºæ ‡å‡†è¯»æ³•
        if (!isCorrect) {
            html += `<p><strong>å»ºè®®è¯»æ³•:</strong> "${standardRead}"</p>`;
        }

        // æµç•…åº¦/ç½®ä¿¡åº¦
        let fluScore = Math.round(confidence * 100);
        html += `<p style="font-size:0.8rem; color:#666;">ç³»ç»Ÿè¯†åˆ«ç½®ä¿¡åº¦ (æµç•…åº¦å‚è€ƒ): ${fluScore}%</p>`;

        // æŒ‰é’®ç»„
        html += `<div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">`;
        html += `<button class="btn-primary" style="font-size:0.8rem;" onclick="retryRound()">ğŸ”„ é‡è¯»ç»ƒä¹ </button>`;
        html += `<button class="btn-outline" style="font-size:0.8rem;" onclick="speakText('${standardRead.replace(/'/g, "\\'")}')">ğŸ”Š å¬æ­£ç¡®è¯»éŸ³</button>`;
        html += `</div>`;

        fbBox.innerHTML = html;
        document.getElementById('statusText').innerText = "ç»ƒä¹ ç»“æŸ";
        // æ›´æ–°å†å²è®°å½•ä¸­å½“å‰æ•°å­—çš„ç»“æœ
        updateHistoryResult(currentNumber, isCorrect);
    }

    function speakText(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US'; 
        utterance.rate = 0.9; // ç¨å¾®æ…¢ä¸€ç‚¹
        window.speechSynthesis.speak(utterance);
    }

    function resetUI() {
        clearInterval(countdownInterval);
        clearTimeout(listeningTimeout);
        clearTimeout(resultTimeout);
        pendingTranscript = null;
        lastResultTime = null;
        document.getElementById('feedbackArea').style.display = 'none';
        document.getElementById('timerDisplay').innerText = "Wait";
        document.getElementById('skipBtn').disabled = true;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('stopBtn').style.display = 'none';
    }

    // === åœæ­¢å½•éŸ³å‡½æ•° ===
    function stopListening() {
        if (isListening && recognition) {
            try {
                recognition.stop();
            } catch (e) {
                console.error('Error stopping recognition:', e);
            }
        }
        isListening = false;
        clearTimeout(listeningTimeout);
        document.getElementById('statusText').classList.remove('listening-pulse');
        document.getElementById('statusText').innerText = "å·²åœæ­¢å½•éŸ³";
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('stopBtn').style.display = 'none';
        
        // ç§»åŠ¨ç«¯ï¼šåœæ­¢åé‡æ–°åˆ›å»ºå¯¹è±¡
        if (isMobileDevice()) {
            recognition = null;
        }
    }

    // === å†å²è®°å½•åŠŸèƒ½ ===
    function addToHistory(number, isCorrect = undefined) {
        // å¦‚æœæ•°å­—å·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
        const index = historyNumbers.findIndex(item => item.number === number);
        if (index > -1) {
            historyNumbers.splice(index, 1);
        }
        
        // æ·»åŠ åˆ°å¼€å¤´
        historyNumbers.unshift({number: number, isCorrect: isCorrect});
        
        // ä¿æŒæœ€å¤š20ä¸ª
        if (historyNumbers.length > MAX_HISTORY) {
            historyNumbers.pop();
        }
        
        // æ›´æ–°æ˜¾ç¤º
        updateHistoryDisplay();
    }

    function updateHistoryResult(number, isCorrect) {
        // æ›´æ–°å†å²è®°å½•ä¸­æŸä¸ªæ•°å­—çš„ç»“æœ
        const item = historyNumbers.find(item => item.number === number);
        if (item) {
            item.isCorrect = isCorrect;
            updateHistoryDisplay();
        }
    }

    function updateHistoryDisplay() {
        const historyList = document.getElementById('historyList');
        
        if (historyNumbers.length === 0) {
            historyList.innerHTML = '<div class="history-empty">æš‚æ— å†å²è®°å½•</div>';
            return;
        }
        
        let html = '';
        historyNumbers.forEach((item) => {
            const num = item.number;
            const formatted = formatNumber(num);
            const isCurrent = num === currentNumber;
            let className = 'history-item';
            let style = '';
            
            // æ ¹æ®ç»“æœæ·»åŠ æ ·å¼ç±»
            if (item.isCorrect === true) {
                className += ' correct';
            } else if (item.isCorrect === false) {
                className += ' wrong';
            }
            
            // å½“å‰æ•°å­—é«˜äº®
            if (isCurrent) {
                style = 'background: var(--primary); color: white; border-color: var(--primary);';
            }
            
            // æ·»åŠ çŠ¶æ€å›¾æ ‡
            let statusIcon = '';
            if (item.isCorrect === true) {
                statusIcon = ' âœ…';
            } else if (item.isCorrect === false) {
                statusIcon = ' âŒ';
            }
            
            html += `<div class="${className}" onclick="startRoundWithNumber(${num})" style="${style}">
                ${formatted}${statusIcon}
            </div>`;
        });
        
        historyList.innerHTML = html;
    }

    function toggleHistory() {
        const historySection = document.getElementById('historySection');
        const toggleBtn = historySection.querySelector('.toggle-history-btn');
        const historyToggleBtn = document.getElementById('historyToggleBtn');
        
        if (historySection.classList.contains('show')) {
            historySection.classList.remove('show');
            toggleBtn.innerText = 'æ˜¾ç¤º';
            if (historyToggleBtn) {
                historyToggleBtn.innerText = 'ğŸ“š æ˜¾ç¤ºå†å²';
            }
        } else {
            historySection.classList.add('show');
            toggleBtn.innerText = 'éšè—';
            if (historyToggleBtn) {
                historyToggleBtn.innerText = 'ğŸ“š éšè—å†å²';
            }
            updateHistoryDisplay();
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå†å²è®°å½•åŒºåŸŸ
    window.addEventListener('load', () => {
        const historySection = document.getElementById('historySection');
        const historyToggleBtn = document.getElementById('historyToggleBtn');
        historySection.classList.add('show');
        if (historyToggleBtn) {
            historyToggleBtn.innerText = 'ğŸ“š éšè—å†å²';
        }
        updateHistoryDisplay();
    });
</script>

</body>
</html>