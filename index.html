<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Billion Number Challenge</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --error: #dc2626;
            --bg: #f8fafc;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
            box-sizing: border-box;
        }
        h1 { 
            margin-top: 0; 
            color: #333;
            font-size: 1.8rem;
        }
        
        .number-display {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--primary);
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
            word-break: break-all;
            line-height: 1.2;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: all 0.2s;
            min-height: 44px; /* è§¦æ‘¸å‹å¥½çš„æœ€å°å°ºå¯¸ */
            touch-action: manipulation; /* ä¼˜åŒ–è§¦æ‘¸å“åº” */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-outline { border: 2px solid #cbd5e1; background: transparent; }
        
        .status-bar {
            height: 30px;
            margin: 10px 0;
            font-weight: bold;
            color: #64748b;
        }

        .timer-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .feedback-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f1f5f9;
            text-align: left;
            display: none;
        }
        .feedback-correct { border-left: 5px solid var(--success); }
        .feedback-wrong { border-left: 5px solid var(--error); }

        .settings {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 0.9rem;
            color: #666;
        }
        input[type="range"] { vertical-align: middle; }

        /* å†å²è®°å½•æ ·å¼ */
        .history-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: none;
        }
        .history-section.show {
            display: block;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #666;
        }
        .history-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .history-item {
            padding: 8px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
            transition: all 0.2s;
            word-break: break-all;
        }
        .history-item:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        .history-item.correct {
            border-left: 4px solid var(--success);
        }
        .history-item.wrong {
            border-left: 4px solid var(--error);
            background: #fef2f2;
        }
        .history-item.wrong:hover {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }
        .history-item {
            min-height: 44px; /* è§¦æ‘¸å‹å¥½çš„æœ€å°å°ºå¯¸ */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .history-empty {
            text-align: center;
            color: #94a3b8;
            padding: 20px;
            font-size: 0.85rem;
        }

        /* å“åº”å¼è®¾è®¡ - å¹³æ¿ */
        @media screen and (max-width: 768px) {
            .container {
                padding: 1.5rem;
                margin: 10px;
            }
            h1 {
                font-size: 1.5rem;
            }
            .number-display {
                font-size: 2.8rem;
                margin: 15px 0;
            }
            .timer-circle {
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }
            .history-list {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                max-height: 180px;
            }
        }

        /* å“åº”å¼è®¾è®¡ - æ‰‹æœº */
        @media screen and (max-width: 480px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 1rem;
                border-radius: 0.75rem;
            }
            h1 {
                font-size: 1.3rem;
                margin-bottom: 10px;
            }
            .number-display {
                font-size: 2.2rem;
                margin: 15px 0;
            }
            .timer-circle {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
                margin-bottom: 15px;
            }
            .controls {
                flex-direction: column;
                gap: 8px;
            }
            button {
                width: 100%;
                padding: 14px 20px;
                font-size: 0.95rem;
            }
            .status-bar {
                font-size: 0.9rem;
                min-height: 24px;
            }
            .settings {
                font-size: 0.85rem;
            }
            .history-section {
                margin-top: 15px;
                padding-top: 15px;
            }
            .history-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .history-title {
                font-size: 0.85rem;
            }
            .history-list {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 6px;
                max-height: 150px;
                padding: 8px;
            }
            .history-item {
                padding: 10px 8px;
                font-size: 0.75rem;
            }
            .feedback-box {
                padding: 12px;
                font-size: 0.9rem;
            }
            .feedback-box h3 {
                font-size: 1rem;
                margin-top: 0;
            }
            .feedback-box p {
                font-size: 0.85rem;
                margin: 8px 0;
            }
            .feedback-box button {
                font-size: 0.8rem;
                padding: 10px 15px;
            }
            .toggle-history-btn {
                min-height: 40px;
                padding: 10px 15px;
                font-size: 0.85rem;
            }
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            body {
                padding: 10px;
            }
            .container {
                padding: 1rem;
            }
            .number-display {
                font-size: 2rem;
                margin: 10px 0;
            }
            .history-list {
                max-height: 120px;
            }
        }
        .toggle-history-btn {
            font-size: 0.8rem;
            padding: 8px 12px;
            background: transparent;
            border: 1px solid #cbd5e1;
            color: #64748b;
            cursor: pointer;
            border-radius: 4px;
            min-height: 36px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .toggle-history-btn:hover {
            background: #f1f5f9;
        }

        /* Animation for listening */
        .listening-pulse {
            animation: pulse 1.5s infinite;
            background-color: #ef4444;
            color: white;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”¢ Billion Number Challenge</h1>
    
    <div class="settings">
        <label>ç­‰å¾…æ—¶é—´: <span id="timeVal">5</span>s</label>
        <input type="range" id="waitRange" min="0" max="10" value="5" oninput="document.getElementById('timeVal').innerText = this.value">
    </div>

    <div class="number-display" id="numberDisplay">---</div>
    
    <div class="timer-circle" id="timerDisplay">Wait</div>
    
    <div class="status-bar" id="statusText">ç‚¹å‡» "å¼€å§‹ç»ƒä¹ "</div>

    <div class="controls">
        <button class="btn-primary" onclick="startRound()" id="startBtn">å¼€å§‹ç»ƒä¹ </button>
        <button class="btn-outline" onclick="skipTimer()" id="skipBtn" disabled>ç›´æ¥è¯» (Skip)</button>
        <button class="btn-outline" onclick="toggleHistory()" id="historyToggleBtn">ğŸ“š å†å²è®°å½•</button>
    </div>

    <div class="feedback-box" id="feedbackArea">
        </div>

    <div class="history-section" id="historySection">
        <div class="history-header">
            <span class="history-title">ğŸ“š å†å²è®°å½• (æœ€è¿‘20ä¸ª)</span>
            <button class="toggle-history-btn" onclick="toggleHistory()">éšè—</button>
        </div>
        <div class="history-list" id="historyList">
            <div class="history-empty">æš‚æ— å†å²è®°å½•</div>
        </div>
    </div>
</div>

<script>
    // === æ ¸å¿ƒé€»è¾‘å˜é‡ ===
    let currentNumber = 0;
    let countdownInterval;
    let recognition;
    let isListening = false;
    let micPermissionGranted = false; // è·Ÿè¸ªéº¦å…‹é£æƒé™æ˜¯å¦å·²è·å–
    let historyNumbers = []; // å†å²è®°å½•æ•°ç»„ï¼Œæœ€å¤šä¿å­˜20ä¸ªæ•°å­—ï¼Œæ ¼å¼: {number: æ•°å­—, isCorrect: true/false/undefined}
    const MAX_HISTORY = 20; // æœ€å¤§å†å²è®°å½•æ•°

    // === æ•°å­—è½¬è‹±æ–‡é€»è¾‘ (æ ¸å¿ƒç®—æ³•) ===
    const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
    const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
    const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];

    function convertGroup(num) {
        let str = '';
        if (num >= 100) {
            str += ones[Math.floor(num / 100)] + ' hundred ';
            num %= 100;
            if (num > 0) str += 'and '; // UK style logic, simplified for normalized check
        }
        if (num >= 20) {
            str += tens[Math.floor(num / 10)] + ' ';
            num %= 10;
        }
        if (num >= 10) {
            str += teens[num - 10] + ' ';
            num = 0;
        }
        if (num > 0) {
            str += ones[num] + ' ';
        }
        return str.trim();
    }

    function numberToEnglish(num) {
        if (num === 0) return "zero";
        
        let str = '';
        
        // Billions
        let billions = Math.floor(num / 1000000000);
        if (billions > 0) str += convertGroup(billions) + ' billion ';
        num %= 1000000000;

        // Millions
        let millions = Math.floor(num / 1000000);
        if (millions > 0) str += convertGroup(millions) + ' million ';
        num %= 1000000;

        // Thousands
        let thousands = Math.floor(num / 1000);
        if (thousands > 0) str += convertGroup(thousands) + ' thousand ';
        num %= 1000;

        // Hundreds/Tens/Ones
        if (num > 0) {
             // Logic to add 'and' if preceding big numbers exist (Standard UK/Commonwealth, optional in US)
            if (str !== '' && num < 100) str += 'and '; 
            str += convertGroup(num);
        }
        
        return str.trim().replace(/\s+/g, ' ');
    }

    // === è¯­éŸ³è¯†åˆ«è®¾ç½® ===
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US'; // é»˜è®¤ç¾å¼ï¼Œå¯æ”¹ä¸º en-GB
        recognition.continuous = true; // æ”¹ä¸ºæŒç»­æ¨¡å¼ï¼Œé¿å…æ¯æ¬¡é‡æ–°è¯·æ±‚æƒé™
        recognition.interimResults = false;

        recognition.onstart = () => {
            isListening = true;
            micPermissionGranted = true; // æ ‡è®°æƒé™å·²è·å–
            document.getElementById('statusText').innerText = "ğŸ¤ æ­£åœ¨è†å¬...";
            document.getElementById('statusText').classList.add('listening-pulse');
            document.getElementById('startBtn').disabled = true;
        };

        recognition.onend = () => {
            isListening = false;
            document.getElementById('statusText').classList.remove('listening-pulse');
            document.getElementById('startBtn').disabled = false;
            // å¦‚æœæƒé™å·²è·å–ï¼Œä¸è‡ªåŠ¨é‡å¯ï¼ˆé¿å…é‡å¤è¯·æ±‚ï¼‰
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            const confidence = event.results[0][0].confidence;
            // æ”¶åˆ°ç»“æœåç«‹å³åœæ­¢è¯†åˆ«
            recognition.stop();
            evaluateAnswer(transcript, confidence);
        };

        recognition.onerror = (event) => {
            // å¦‚æœæ˜¯æƒé™é”™è¯¯ï¼Œé‡ç½®æ ‡å¿—
            if (event.error === 'not-allowed' || event.error === 'no-speech') {
                micPermissionGranted = false;
            }
            document.getElementById('statusText').innerText = "âš ï¸ è¯†åˆ«é”™è¯¯: " + event.error;
            isListening = false;
            recognition.stop(); // ç¡®ä¿åœæ­¢è¯†åˆ«
        };
    } else {
        alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨ Google Chrome æˆ– Edgeã€‚");
    }

    // === æµç¨‹æ§åˆ¶ ===
    function generateRandomNumber() {
        // ä½¿ç”¨å¯¹æ•°åˆ†å¸ƒï¼Œè®©ä¸åŒæ•°é‡çº§çš„æ•°å­—å‡ºç°æ¦‚ç‡æ›´å‡åŒ€
        // ç”Ÿæˆ 0 åˆ° 1,000,000,000 çš„æ•°å­—
        const max = 1000000000;
        // ä½¿ç”¨å¯¹æ•°éšæœºï¼Œè®©0-100, 100-1000, 1000-10000ç­‰å„æ•°é‡çº§å‡ºç°æ¦‚ç‡ç›¸è¿‘
        const logMax = Math.log10(max + 1);
        const randomLog = Math.random() * logMax;
        const number = Math.floor(Math.pow(10, randomLog));
        return number;
    }

    function formatNumber(num) {
        return num.toLocaleString('en-US'); // æ˜¾ç¤ºåƒåˆ†ä½
    }

    function startRound() {
        resetUI();
        currentNumber = generateRandomNumber();
        addToHistory(currentNumber, undefined); // æ·»åŠ åˆ°å†å²è®°å½•ï¼Œç»“æœæœªçŸ¥
        document.getElementById('numberDisplay').innerText = formatNumber(currentNumber);
        
        const waitTime = parseInt(document.getElementById('waitRange').value);
        
        if (waitTime > 0) {
            let timeLeft = waitTime;
            document.getElementById('timerDisplay').innerText = timeLeft;
            document.getElementById('skipBtn').disabled = false;
            document.getElementById('statusText').innerText = "è¯·åœ¨å€’è®¡æ—¶ç»“æŸåæœ—è¯»...";
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    activateListening();
                }
            }, 1000);
        } else {
            activateListening();
        }
    }

    function startRoundWithNumber(number) {
        // ä»å†å²è®°å½•é€‰æ‹©æ•°å­—å¼€å§‹ç»ƒä¹ 
        resetUI();
        currentNumber = number;
        document.getElementById('numberDisplay').innerText = formatNumber(currentNumber);
        
        const waitTime = parseInt(document.getElementById('waitRange').value);
        
        if (waitTime > 0) {
            let timeLeft = waitTime;
            document.getElementById('timerDisplay').innerText = timeLeft;
            document.getElementById('skipBtn').disabled = false;
            document.getElementById('statusText').innerText = "è¯·åœ¨å€’è®¡æ—¶ç»“æŸåæœ—è¯»...";
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    activateListening();
                }
            }, 1000);
        } else {
            activateListening();
        }
    }

    function retryRound() {
        // é‡è¯»å½“å‰æ•°å­—ï¼Œä¸ç”Ÿæˆæ–°æ•°å­—
        resetUI();
        // currentNumber ä¿æŒä¸å˜ï¼Œåªé‡ç½®UIå¹¶é‡æ–°å¼€å§‹å€’è®¡æ—¶
        
        const waitTime = parseInt(document.getElementById('waitRange').value);
        
        if (waitTime > 0) {
            let timeLeft = waitTime;
            document.getElementById('timerDisplay').innerText = timeLeft;
            document.getElementById('skipBtn').disabled = false;
            document.getElementById('statusText').innerText = "è¯·åœ¨å€’è®¡æ—¶ç»“æŸåé‡æ–°æœ—è¯»...";
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    activateListening();
                }
            }, 1000);
        } else {
            activateListening();
        }
    }

    function skipTimer() {
        clearInterval(countdownInterval);
        document.getElementById('timerDisplay').innerText = "Go";
        activateListening();
    }

    function activateListening() {
        document.getElementById('skipBtn').disabled = true;
        document.getElementById('timerDisplay').innerText = "ğŸ¤";
        try {
            // å¦‚æœè¯†åˆ«å·²ç»åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢å†å¯åŠ¨
            if (isListening) {
                recognition.stop();
                // ç­‰å¾…åœæ­¢åå†å¯åŠ¨
                setTimeout(() => {
                    recognition.start();
                }, 100);
            } else {
                recognition.start();
            }
        } catch (e) {
            // å¦‚æœè¯†åˆ«å·²ç»åœ¨è¿è¡Œï¼Œå°è¯•åœæ­¢åé‡æ–°å¯åŠ¨
            if (e.name === 'InvalidStateError') {
                recognition.stop();
                setTimeout(() => {
                    try {
                        recognition.start();
                    } catch (e2) {
                        console.error(e2);
                    }
                }, 100);
            } else {
                console.error(e);
            }
        }
    }

    // === åˆ¤å®šä¸åé¦ˆé€»è¾‘ ===
    function evaluateAnswer(userSpeech, confidence) {
        const standardRead = numberToEnglish(currentNumber).toLowerCase();
        const userRead = userSpeech.toLowerCase(); // ç”¨æˆ·è¯»çš„
        
        // ç®€å•çš„æ•°æ®æ¸…æ´—ï¼šç§»é™¤æ ‡ç‚¹ï¼Œå°†æ•°å­—å­—ç¬¦è½¬ä¸ºå•è¯ï¼ˆå¦‚æœè¯†åˆ«å¼•æ“è¾“å‡ºäº† "123" è€Œä¸æ˜¯ "one hundred..."ï¼‰
        // æ³¨æ„ï¼šWeb Speech API æœ‰æ—¶ä¼šç›´æ¥è¿”å›é˜¿æ‹‰ä¼¯æ•°å­—ï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºç®€åŒ–ï¼Œæˆ‘ä»¬ä¸»è¦æ¯”å¯¹æ–‡æœ¬ã€‚
        // å¦‚æœAPIè¿”å› "150"ï¼Œæˆ‘ä»¬éœ€è¦å®¹é”™ã€‚å®é™…ä¸ŠAPIåœ¨è‹±æ–‡æ¨¡å¼é€šå¸¸è¿”å› "one hundred fifty"ã€‚

        // æ ‡å‡†åŒ–å¤„ç†ï¼šç§»é™¤ "and", "-" ä»¥å…¼å®¹ä¸åŒå£éŸ³å’Œè¿è¯»
        const cleanStandard = standardRead.replace(/ and /g, ' ').replace(/-/g, ' ');
        const cleanUser = userRead.replace(/ and /g, ' ').replace(/-/g, ' ');

        // åˆ¤å®šé€»è¾‘
        let isCorrect = cleanUser.includes(cleanStandard);
        
        // é’ˆå¯¹APIå¯èƒ½è¿”å›é˜¿æ‹‰ä¼¯æ•°å­—çš„ç‰¹æ®Šå¤„ç† (å¦‚ç”¨æˆ·è¯´ "one hundred"ï¼ŒAPIè¿”å› "100")
        // è¿™ç§æƒ…å†µä¸‹ï¼Œç›´æ¥æ¯”å¯¹ currentNumber å’Œ userRead è½¬æ¢åçš„æ•°å­—
        // è¿™é‡Œåšä¸€ä¸ªç®€åŒ–çš„æ¨¡ç³ŠåŒ¹é…ï¼š
        if (!isCorrect) {
            // å°è¯•ç§»é™¤æ‰€æœ‰éæ•°å­—å­—ç¬¦ï¼Œçœ‹æ˜¯å¦ç­‰äºåŸæ•°å­—ï¼ˆé’ˆå¯¹APIè¿”å›é˜¿æ‹‰ä¼¯æ•°å­—çš„æƒ…å†µï¼‰
            const userNums = userRead.replace(/[^0-9]/g, '');
            if (userNums == currentNumber) isCorrect = true;
        }

        showFeedback(isCorrect, userRead, standardRead, confidence);
    }

    function showFeedback(isCorrect, userRead, standardRead, confidence) {
        const fbBox = document.getElementById('feedbackArea');
        fbBox.style.display = 'block';
        fbBox.className = 'feedback-box ' + (isCorrect ? 'feedback-correct' : 'feedback-wrong');

        let html = `<h3>${isCorrect ? 'âœ… è¯»æ³•æ­£ç¡®!' : 'âŒ éœ€è¦æ”¹è¿›'}</h3>`;
        html += `<p><strong>ä½ çš„å‘éŸ³è¯†åˆ«:</strong> "${userRead}"</p>`;
        
        // åªæœ‰é”™è¯¯æ—¶æ‰æ˜¾ç¤ºæ ‡å‡†è¯»æ³•
        if (!isCorrect) {
            html += `<p><strong>å»ºè®®è¯»æ³•:</strong> "${standardRead}"</p>`;
        }

        // æµç•…åº¦/ç½®ä¿¡åº¦
        let fluScore = Math.round(confidence * 100);
        html += `<p style="font-size:0.8rem; color:#666;">ç³»ç»Ÿè¯†åˆ«ç½®ä¿¡åº¦ (æµç•…åº¦å‚è€ƒ): ${fluScore}%</p>`;

        // æŒ‰é’®ç»„
        html += `<div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">`;
        html += `<button class="btn-primary" style="font-size:0.8rem;" onclick="retryRound()">ğŸ”„ é‡è¯»ç»ƒä¹ </button>`;
        html += `<button class="btn-outline" style="font-size:0.8rem;" onclick="speakText('${standardRead.replace(/'/g, "\\'")}')">ğŸ”Š å¬æ­£ç¡®è¯»éŸ³</button>`;
        html += `</div>`;

        fbBox.innerHTML = html;
        document.getElementById('statusText').innerText = "ç»ƒä¹ ç»“æŸ";
        // æ›´æ–°å†å²è®°å½•ä¸­å½“å‰æ•°å­—çš„ç»“æœ
        updateHistoryResult(currentNumber, isCorrect);
    }

    function speakText(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US'; 
        utterance.rate = 0.9; // ç¨å¾®æ…¢ä¸€ç‚¹
        window.speechSynthesis.speak(utterance);
    }

    function resetUI() {
        clearInterval(countdownInterval);
        document.getElementById('feedbackArea').style.display = 'none';
        document.getElementById('timerDisplay').innerText = "Wait";
        document.getElementById('skipBtn').disabled = true;
    }

    // === å†å²è®°å½•åŠŸèƒ½ ===
    function addToHistory(number, isCorrect = undefined) {
        // å¦‚æœæ•°å­—å·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
        const index = historyNumbers.findIndex(item => item.number === number);
        if (index > -1) {
            historyNumbers.splice(index, 1);
        }
        
        // æ·»åŠ åˆ°å¼€å¤´
        historyNumbers.unshift({number: number, isCorrect: isCorrect});
        
        // ä¿æŒæœ€å¤š20ä¸ª
        if (historyNumbers.length > MAX_HISTORY) {
            historyNumbers.pop();
        }
        
        // æ›´æ–°æ˜¾ç¤º
        updateHistoryDisplay();
    }

    function updateHistoryResult(number, isCorrect) {
        // æ›´æ–°å†å²è®°å½•ä¸­æŸä¸ªæ•°å­—çš„ç»“æœ
        const item = historyNumbers.find(item => item.number === number);
        if (item) {
            item.isCorrect = isCorrect;
            updateHistoryDisplay();
        }
    }

    function updateHistoryDisplay() {
        const historyList = document.getElementById('historyList');
        
        if (historyNumbers.length === 0) {
            historyList.innerHTML = '<div class="history-empty">æš‚æ— å†å²è®°å½•</div>';
            return;
        }
        
        let html = '';
        historyNumbers.forEach((item) => {
            const num = item.number;
            const formatted = formatNumber(num);
            const isCurrent = num === currentNumber;
            let className = 'history-item';
            let style = '';
            
            // æ ¹æ®ç»“æœæ·»åŠ æ ·å¼ç±»
            if (item.isCorrect === true) {
                className += ' correct';
            } else if (item.isCorrect === false) {
                className += ' wrong';
            }
            
            // å½“å‰æ•°å­—é«˜äº®
            if (isCurrent) {
                style = 'background: var(--primary); color: white; border-color: var(--primary);';
            }
            
            // æ·»åŠ çŠ¶æ€å›¾æ ‡
            let statusIcon = '';
            if (item.isCorrect === true) {
                statusIcon = ' âœ…';
            } else if (item.isCorrect === false) {
                statusIcon = ' âŒ';
            }
            
            html += `<div class="${className}" onclick="startRoundWithNumber(${num})" style="${style}">
                ${formatted}${statusIcon}
            </div>`;
        });
        
        historyList.innerHTML = html;
    }

    function toggleHistory() {
        const historySection = document.getElementById('historySection');
        const toggleBtn = historySection.querySelector('.toggle-history-btn');
        const historyToggleBtn = document.getElementById('historyToggleBtn');
        
        if (historySection.classList.contains('show')) {
            historySection.classList.remove('show');
            toggleBtn.innerText = 'æ˜¾ç¤º';
            if (historyToggleBtn) {
                historyToggleBtn.innerText = 'ğŸ“š æ˜¾ç¤ºå†å²';
            }
        } else {
            historySection.classList.add('show');
            toggleBtn.innerText = 'éšè—';
            if (historyToggleBtn) {
                historyToggleBtn.innerText = 'ğŸ“š éšè—å†å²';
            }
            updateHistoryDisplay();
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå†å²è®°å½•åŒºåŸŸ
    window.addEventListener('load', () => {
        const historySection = document.getElementById('historySection');
        const historyToggleBtn = document.getElementById('historyToggleBtn');
        historySection.classList.add('show');
        if (historyToggleBtn) {
            historyToggleBtn.innerText = 'ğŸ“š éšè—å†å²';
        }
        updateHistoryDisplay();
    });
</script>

</body>
</html>