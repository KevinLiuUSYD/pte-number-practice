<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billion Number Challenge</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --error: #dc2626;
            --bg: #f8fafc;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
        }
        h1 { margin-top: 0; color: #333; }
        
        .number-display {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--primary);
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
            word-break: break-all;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-outline { border: 2px solid #cbd5e1; background: transparent; }
        
        .status-bar {
            height: 30px;
            margin: 10px 0;
            font-weight: bold;
            color: #64748b;
        }

        .timer-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .feedback-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f1f5f9;
            text-align: left;
            display: none;
        }
        .feedback-correct { border-left: 5px solid var(--success); }
        .feedback-wrong { border-left: 5px solid var(--error); }

        .settings {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 0.9rem;
            color: #666;
        }
        input[type="range"] { vertical-align: middle; }

        /* Animation for listening */
        .listening-pulse {
            animation: pulse 1.5s infinite;
            background-color: #ef4444;
            color: white;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”¢ Billion Number Challenge</h1>
    
    <div class="settings">
        <label>ç­‰å¾…æ—¶é—´: <span id="timeVal">5</span>s</label>
        <input type="range" id="waitRange" min="0" max="10" value="5" oninput="document.getElementById('timeVal').innerText = this.value">
    </div>

    <div class="number-display" id="numberDisplay">---</div>
    
    <div class="timer-circle" id="timerDisplay">Wait</div>
    
    <div class="status-bar" id="statusText">ç‚¹å‡» "å¼€å§‹ç»ƒä¹ "</div>

    <div class="controls">
        <button class="btn-primary" onclick="startRound()" id="startBtn">å¼€å§‹ç»ƒä¹ </button>
        <button class="btn-outline" onclick="skipTimer()" id="skipBtn" disabled>ç›´æ¥è¯» (Skip)</button>
    </div>

    <div class="feedback-box" id="feedbackArea">
        </div>
</div>

<script>
    // === æ ¸å¿ƒé€»è¾‘å˜é‡ ===
    let currentNumber = 0;
    let countdownInterval;
    let recognition;
    let isListening = false;
    let micPermissionGranted = false; // è·Ÿè¸ªéº¦å…‹é£æƒé™æ˜¯å¦å·²è·å–

    // === æ•°å­—è½¬è‹±æ–‡é€»è¾‘ (æ ¸å¿ƒç®—æ³•) ===
    const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
    const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
    const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];

    function convertGroup(num) {
        let str = '';
        if (num >= 100) {
            str += ones[Math.floor(num / 100)] + ' hundred ';
            num %= 100;
            if (num > 0) str += 'and '; // UK style logic, simplified for normalized check
        }
        if (num >= 20) {
            str += tens[Math.floor(num / 10)] + ' ';
            num %= 10;
        }
        if (num >= 10) {
            str += teens[num - 10] + ' ';
            num = 0;
        }
        if (num > 0) {
            str += ones[num] + ' ';
        }
        return str.trim();
    }

    function numberToEnglish(num) {
        if (num === 0) return "zero";
        
        let str = '';
        
        // Billions
        let billions = Math.floor(num / 1000000000);
        if (billions > 0) str += convertGroup(billions) + ' billion ';
        num %= 1000000000;

        // Millions
        let millions = Math.floor(num / 1000000);
        if (millions > 0) str += convertGroup(millions) + ' million ';
        num %= 1000000;

        // Thousands
        let thousands = Math.floor(num / 1000);
        if (thousands > 0) str += convertGroup(thousands) + ' thousand ';
        num %= 1000;

        // Hundreds/Tens/Ones
        if (num > 0) {
             // Logic to add 'and' if preceding big numbers exist (Standard UK/Commonwealth, optional in US)
            if (str !== '' && num < 100) str += 'and '; 
            str += convertGroup(num);
        }
        
        return str.trim().replace(/\s+/g, ' ');
    }

    // === è¯­éŸ³è¯†åˆ«è®¾ç½® ===
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US'; // é»˜è®¤ç¾å¼ï¼Œå¯æ”¹ä¸º en-GB
        recognition.continuous = true; // æ”¹ä¸ºæŒç»­æ¨¡å¼ï¼Œé¿å…æ¯æ¬¡é‡æ–°è¯·æ±‚æƒé™
        recognition.interimResults = false;

        recognition.onstart = () => {
            isListening = true;
            micPermissionGranted = true; // æ ‡è®°æƒé™å·²è·å–
            document.getElementById('statusText').innerText = "ğŸ¤ æ­£åœ¨è†å¬...";
            document.getElementById('statusText').classList.add('listening-pulse');
            document.getElementById('startBtn').disabled = true;
        };

        recognition.onend = () => {
            isListening = false;
            document.getElementById('statusText').classList.remove('listening-pulse');
            document.getElementById('startBtn').disabled = false;
            // å¦‚æœæƒé™å·²è·å–ï¼Œä¸è‡ªåŠ¨é‡å¯ï¼ˆé¿å…é‡å¤è¯·æ±‚ï¼‰
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            const confidence = event.results[0][0].confidence;
            // æ”¶åˆ°ç»“æœåç«‹å³åœæ­¢è¯†åˆ«
            recognition.stop();
            evaluateAnswer(transcript, confidence);
        };

        recognition.onerror = (event) => {
            // å¦‚æœæ˜¯æƒé™é”™è¯¯ï¼Œé‡ç½®æ ‡å¿—
            if (event.error === 'not-allowed' || event.error === 'no-speech') {
                micPermissionGranted = false;
            }
            document.getElementById('statusText').innerText = "âš ï¸ è¯†åˆ«é”™è¯¯: " + event.error;
            isListening = false;
            recognition.stop(); // ç¡®ä¿åœæ­¢è¯†åˆ«
        };
    } else {
        alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨ Google Chrome æˆ– Edgeã€‚");
    }

    // === æµç¨‹æ§åˆ¶ ===
    function generateRandomNumber() {
        // ä½¿ç”¨å¯¹æ•°åˆ†å¸ƒï¼Œè®©ä¸åŒæ•°é‡çº§çš„æ•°å­—å‡ºç°æ¦‚ç‡æ›´å‡åŒ€
        // ç”Ÿæˆ 0 åˆ° 1,000,000,000 çš„æ•°å­—
        const max = 1000000000;
        // ä½¿ç”¨å¯¹æ•°éšæœºï¼Œè®©0-100, 100-1000, 1000-10000ç­‰å„æ•°é‡çº§å‡ºç°æ¦‚ç‡ç›¸è¿‘
        const logMax = Math.log10(max + 1);
        const randomLog = Math.random() * logMax;
        const number = Math.floor(Math.pow(10, randomLog));
        return number;
    }

    function formatNumber(num) {
        return num.toLocaleString('en-US'); // æ˜¾ç¤ºåƒåˆ†ä½
    }

    function startRound() {
        resetUI();
        currentNumber = generateRandomNumber();
        document.getElementById('numberDisplay').innerText = formatNumber(currentNumber);
        
        const waitTime = parseInt(document.getElementById('waitRange').value);
        
        if (waitTime > 0) {
            let timeLeft = waitTime;
            document.getElementById('timerDisplay').innerText = timeLeft;
            document.getElementById('skipBtn').disabled = false;
            document.getElementById('statusText').innerText = "è¯·åœ¨å€’è®¡æ—¶ç»“æŸåæœ—è¯»...";
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    activateListening();
                }
            }, 1000);
        } else {
            activateListening();
        }
    }

    function retryRound() {
        // é‡è¯»å½“å‰æ•°å­—ï¼Œä¸ç”Ÿæˆæ–°æ•°å­—
        resetUI();
        // currentNumber ä¿æŒä¸å˜ï¼Œåªé‡ç½®UIå¹¶é‡æ–°å¼€å§‹å€’è®¡æ—¶
        
        const waitTime = parseInt(document.getElementById('waitRange').value);
        
        if (waitTime > 0) {
            let timeLeft = waitTime;
            document.getElementById('timerDisplay').innerText = timeLeft;
            document.getElementById('skipBtn').disabled = false;
            document.getElementById('statusText').innerText = "è¯·åœ¨å€’è®¡æ—¶ç»“æŸåé‡æ–°æœ—è¯»...";
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    activateListening();
                }
            }, 1000);
        } else {
            activateListening();
        }
    }

    function skipTimer() {
        clearInterval(countdownInterval);
        document.getElementById('timerDisplay').innerText = "Go";
        activateListening();
    }

    function activateListening() {
        document.getElementById('skipBtn').disabled = true;
        document.getElementById('timerDisplay').innerText = "ğŸ¤";
        try {
            // å¦‚æœè¯†åˆ«å·²ç»åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢å†å¯åŠ¨
            if (isListening) {
                recognition.stop();
                // ç­‰å¾…åœæ­¢åå†å¯åŠ¨
                setTimeout(() => {
                    recognition.start();
                }, 100);
            } else {
                recognition.start();
            }
        } catch (e) {
            // å¦‚æœè¯†åˆ«å·²ç»åœ¨è¿è¡Œï¼Œå°è¯•åœæ­¢åé‡æ–°å¯åŠ¨
            if (e.name === 'InvalidStateError') {
                recognition.stop();
                setTimeout(() => {
                    try {
                        recognition.start();
                    } catch (e2) {
                        console.error(e2);
                    }
                }, 100);
            } else {
                console.error(e);
            }
        }
    }

    // === åˆ¤å®šä¸åé¦ˆé€»è¾‘ ===
    function evaluateAnswer(userSpeech, confidence) {
        const standardRead = numberToEnglish(currentNumber).toLowerCase();
        const userRead = userSpeech.toLowerCase(); // ç”¨æˆ·è¯»çš„
        
        // ç®€å•çš„æ•°æ®æ¸…æ´—ï¼šç§»é™¤æ ‡ç‚¹ï¼Œå°†æ•°å­—å­—ç¬¦è½¬ä¸ºå•è¯ï¼ˆå¦‚æœè¯†åˆ«å¼•æ“è¾“å‡ºäº† "123" è€Œä¸æ˜¯ "one hundred..."ï¼‰
        // æ³¨æ„ï¼šWeb Speech API æœ‰æ—¶ä¼šç›´æ¥è¿”å›é˜¿æ‹‰ä¼¯æ•°å­—ï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºç®€åŒ–ï¼Œæˆ‘ä»¬ä¸»è¦æ¯”å¯¹æ–‡æœ¬ã€‚
        // å¦‚æœAPIè¿”å› "150"ï¼Œæˆ‘ä»¬éœ€è¦å®¹é”™ã€‚å®é™…ä¸ŠAPIåœ¨è‹±æ–‡æ¨¡å¼é€šå¸¸è¿”å› "one hundred fifty"ã€‚

        // æ ‡å‡†åŒ–å¤„ç†ï¼šç§»é™¤ "and", "-" ä»¥å…¼å®¹ä¸åŒå£éŸ³å’Œè¿è¯»
        const cleanStandard = standardRead.replace(/ and /g, ' ').replace(/-/g, ' ');
        const cleanUser = userRead.replace(/ and /g, ' ').replace(/-/g, ' ');

        // åˆ¤å®šé€»è¾‘
        let isCorrect = cleanUser.includes(cleanStandard);
        
        // é’ˆå¯¹APIå¯èƒ½è¿”å›é˜¿æ‹‰ä¼¯æ•°å­—çš„ç‰¹æ®Šå¤„ç† (å¦‚ç”¨æˆ·è¯´ "one hundred"ï¼ŒAPIè¿”å› "100")
        // è¿™ç§æƒ…å†µä¸‹ï¼Œç›´æ¥æ¯”å¯¹ currentNumber å’Œ userRead è½¬æ¢åçš„æ•°å­—
        // è¿™é‡Œåšä¸€ä¸ªç®€åŒ–çš„æ¨¡ç³ŠåŒ¹é…ï¼š
        if (!isCorrect) {
            // å°è¯•ç§»é™¤æ‰€æœ‰éæ•°å­—å­—ç¬¦ï¼Œçœ‹æ˜¯å¦ç­‰äºåŸæ•°å­—ï¼ˆé’ˆå¯¹APIè¿”å›é˜¿æ‹‰ä¼¯æ•°å­—çš„æƒ…å†µï¼‰
            const userNums = userRead.replace(/[^0-9]/g, '');
            if (userNums == currentNumber) isCorrect = true;
        }

        showFeedback(isCorrect, userRead, standardRead, confidence);
    }

    function showFeedback(isCorrect, userRead, standardRead, confidence) {
        const fbBox = document.getElementById('feedbackArea');
        fbBox.style.display = 'block';
        fbBox.className = 'feedback-box ' + (isCorrect ? 'feedback-correct' : 'feedback-wrong');

        let html = `<h3>${isCorrect ? 'âœ… è¯»æ³•æ­£ç¡®!' : 'âŒ éœ€è¦æ”¹è¿›'}</h3>`;
        html += `<p><strong>ä½ çš„å‘éŸ³è¯†åˆ«:</strong> "${userRead}"</p>`;
        
        // åªæœ‰é”™è¯¯æ—¶æ‰æ˜¾ç¤ºæ ‡å‡†è¯»æ³•
        if (!isCorrect) {
            html += `<p><strong>å»ºè®®è¯»æ³•:</strong> "${standardRead}"</p>`;
        }

        // æµç•…åº¦/ç½®ä¿¡åº¦
        let fluScore = Math.round(confidence * 100);
        html += `<p style="font-size:0.8rem; color:#666;">ç³»ç»Ÿè¯†åˆ«ç½®ä¿¡åº¦ (æµç•…åº¦å‚è€ƒ): ${fluScore}%</p>`;

        // æŒ‰é’®ç»„
        html += `<div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">`;
        html += `<button class="btn-primary" style="font-size:0.8rem;" onclick="retryRound()">ğŸ”„ é‡è¯»ç»ƒä¹ </button>`;
        html += `<button class="btn-outline" style="font-size:0.8rem;" onclick="speakText('${standardRead.replace(/'/g, "\\'")}')">ğŸ”Š å¬æ­£ç¡®è¯»éŸ³</button>`;
        html += `</div>`;

        fbBox.innerHTML = html;
        document.getElementById('statusText').innerText = "ç»ƒä¹ ç»“æŸ";
    }

    function speakText(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US'; 
        utterance.rate = 0.9; // ç¨å¾®æ…¢ä¸€ç‚¹
        window.speechSynthesis.speak(utterance);
    }

    function resetUI() {
        clearInterval(countdownInterval);
        document.getElementById('feedbackArea').style.display = 'none';
        document.getElementById('timerDisplay').innerText = "Wait";
        document.getElementById('skipBtn').disabled = true;
    }
</script>

</body>
</html>