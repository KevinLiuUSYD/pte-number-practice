<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>å¬å†™ç»ƒä¹  - PTEç»ƒä¹ ç½‘ç«™</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --error: #dc2626;
            --bg: #f8fafc;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .nav-link:hover {
            background: #f1f5f9;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
            box-sizing: border-box;
            margin-top: 60px;
        }
        h1 { 
            margin-top: 0; 
            color: #333;
            font-size: 1.8rem;
        }
        
        .audio-controls {
            margin: 30px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .play-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .play-button:hover {
            background: #1d4ed8;
            transform: scale(1.05);
        }
        .play-button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }
        .play-button.playing {
            background: var(--error);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .play-hint {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .input-section {
            margin: 30px 0;
        }
        .dictation-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.2rem;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            text-align: center;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .dictation-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .dictation-input:disabled {
            background: #f1f5f9;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: all 0.2s;
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        .btn-primary:hover { 
            background: #1d4ed8; 
        }
        .btn-primary:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .btn-outline { 
            border: 2px solid #cbd5e1; 
            background: transparent; 
        }
        .btn-outline:hover {
            background: #f1f5f9;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-success:hover {
            background: #15803d;
        }
        
        .feedback-box {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background: #f1f5f9;
            text-align: left;
            display: none;
        }
        .feedback-correct { 
            border-left: 5px solid var(--success); 
            background: #f0fdf4;
        }
        .feedback-wrong { 
            border-left: 5px solid var(--error); 
            background: #fef2f2;
        }
        .feedback-box h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .feedback-box .answers {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .feedback-box .answers strong {
            color: var(--primary);
        }
        .answer-item {
            display: inline-block;
            margin: 5px 10px 5px 0;
            padding: 5px 12px;
            background: #e0e7ff;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        /* é”™é¢˜æœ¬ç®¡ç† */
        .notebook-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .notebook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .notebook-title {
            font-size: 1rem;
            font-weight: bold;
            color: #666;
        }
        .notebook-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            text-align: left;
        }
        .notebook-item {
            padding: 10px 15px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notebook-item-content {
            flex: 1;
        }
        .notebook-item-text {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .notebook-item-text.hidden {
            display: none;
        }
        .notebook-item-stats {
            color: #94a3b8;
            font-size: 0.75rem;
            margin-top: 4px;
        }
        .notebook-item-stats.hidden {
            display: none;
        }
        .notebook-item-stats .stat-correct {
            color: var(--success);
        }
        .notebook-item-stats .stat-wrong {
            color: var(--error);
        }
        .toggle-answer-btn {
            font-size: 0.75rem;
            padding: 3px 8px;
            min-height: auto;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
        }
        .toggle-answer-btn:hover {
            background: #e2e8f0;
        }
        .notebook-item-actions {
            display: flex;
            gap: 5px;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
            min-height: auto;
        }
        .btn-danger {
            background: var(--error);
            color: white;
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        .notebook-empty {
            text-align: center;
            color: #94a3b8;
            padding: 20px;
            font-size: 0.9rem;
        }

        /* æ–°å¢é”™é¢˜æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        /* æ–°å¢æ¨¡æ€æ¡†çš„z-indexæ›´é«˜ï¼Œç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚ */
        #addModal {
            z-index: 2100;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #333;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        .form-group .hint {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media screen and (max-width: 768px) {
            .container {
                padding: 1.5rem;
                margin: 10px;
                margin-top: 70px;
            }
            h1 {
                font-size: 1.5rem;
            }
            .play-button {
                width: 70px;
                height: 70px;
                font-size: 2rem;
            }
        }

        @media screen and (max-width: 480px) {
            body {
                padding: 10px;
            }
            .nav-bar {
                padding: 8px 15px;
                font-size: 0.85rem;
            }
            .container {
                padding: 1rem;
                border-radius: 0.75rem;
                margin-top: 60px;
            }
            h1 {
                font-size: 1.3rem;
                margin-bottom: 10px;
            }
            .play-button {
                width: 60px;
                height: 60px;
                font-size: 1.8rem;
            }
            .dictation-input {
                font-size: 1rem;
                padding: 12px 15px;
            }
            .controls {
                flex-direction: column;
                gap: 8px;
            }
            button {
                width: 100%;
                padding: 14px 20px;
                font-size: 0.95rem;
            }
            .modal-content {
                padding: 1.5rem;
            }
            .modal-header {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>

<nav class="nav-bar">
    <a href="index.html" class="nav-link">ğŸ  è¿”å›ä¸»é¡µ</a>
    <span style="color: #64748b; font-size: 0.9rem;">ğŸ§ å¬å†™ç»ƒä¹ </span>
</nav>

<div class="container">
    <h1>ğŸ§ å¬å†™ç»ƒä¹ </h1>
    
    <div class="audio-controls">
        <button class="play-button" id="playButton" onclick="playAudio()" title="ç‚¹å‡»æ’­æ”¾">â–¶</button>
        <div class="play-hint" id="playHint">ç‚¹å‡»æ’­æ”¾æŒ‰é’®ï¼Œå¬å†™å•è¯/çŸ­è¯­/å¥å­</div>
    </div>
    
    <div class="input-section">
        <input 
            type="text" 
            id="dictationInput" 
            class="dictation-input" 
            placeholder="è¯·è¾“å…¥å¬åˆ°çš„å†…å®¹..."
            autocomplete="off"
            onkeypress="if(event.key==='Enter') checkAnswer()"
        >
    </div>

    <div class="controls">
        <button class="btn-primary" onclick="checkAnswer()" id="checkBtn">æ£€æŸ¥ç­”æ¡ˆ</button>
        <button class="btn-outline" onclick="nextQuestion()" id="nextBtn" style="display: none;">ä¸‹ä¸€é¢˜</button>
        <button class="btn-outline" onclick="openNotebookModal()">ğŸ“š é”™é¢˜æœ¬</button>
    </div>

    <div class="feedback-box" id="feedbackArea"></div>
</div>

<!-- æ–°å¢é”™é¢˜æ¨¡æ€æ¡† -->
<div class="modal" id="addModal">
    <div class="modal-content">
        <div class="modal-header">æ–°å¢å¬å†™å†…å®¹</div>
        <div class="form-group">
            <label>å•è¯/çŸ­è¯­/å¥å­ï¼š</label>
            <textarea id="addText" placeholder="ä¾‹å¦‚ï¼šconvenient&#10;æˆ–è€…ï¼šIt is very convenient.&#10;æˆ–è€…ï¼šmake a difference"></textarea>
            <div class="hint">ğŸ’¡ æç¤ºï¼šå¯ä»¥è¾“å…¥å•è¯ã€çŸ­è¯­æˆ–å®Œæ•´å¥å­</div>
        </div>
        <div class="modal-actions">
            <button class="btn-outline" onclick="closeAddModal()">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="addToNotebook()">æ·»åŠ </button>
        </div>
    </div>
</div>

<!-- é”™é¢˜æœ¬æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div class="modal" id="notebookModal">
    <div class="modal-content">
        <div class="modal-header">ğŸ“š é”™é¢˜æœ¬ç®¡ç†</div>
        <div style="margin-bottom: 1rem; display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn-primary" onclick="openAddModal()" style="flex: 1; min-width: 120px;">+ æ–°å¢å†…å®¹</button>
            <button class="btn-outline" onclick="loadSampleData()" style="flex: 1; min-width: 100px;">ğŸ“‹ ç¤ºä¾‹æ•°æ®</button>
            <button class="btn-outline" onclick="exportNotebook()" style="flex: 1; min-width: 100px;">ğŸ“¥ å¯¼å‡º</button>
            <button class="btn-outline" onclick="importNotebook()" style="flex: 1; min-width: 100px;">ğŸ“¤ å¯¼å…¥</button>
            <button class="btn-danger" onclick="clearNotebook()" style="flex: 1; min-width: 100px;">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        <div style="margin-bottom: 1rem; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 0.85rem; color: #0369a1;">
            ğŸ’¡ æç¤ºï¼šé”™é¢˜æœ¬æ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ã€‚å¯ä»¥å¯¼å‡ºå¤‡ä»½æˆ–å¯¼å…¥ä»–äººçš„é”™é¢˜æœ¬ã€‚
        </div>
        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
            <span style="font-size: 0.9rem; color: #64748b;">å…± <strong id="notebookCount">0</strong> æ¡å†…å®¹</span>
            <div style="display: flex; gap: 8px;">
                <button class="toggle-answer-btn" onclick="toggleStats()" id="toggleStatsBtn">æ˜¾ç¤ºç»Ÿè®¡</button>
            </div>
        </div>
        <div class="notebook-list" id="notebookModalList">
            <div class="notebook-empty">æš‚æ— å¬å†™å†…å®¹</div>
        </div>
        <div class="modal-actions">
            <button class="btn-outline" onclick="closeNotebookModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- å¯¼å…¥é”™é¢˜æœ¬æ¨¡æ€æ¡† -->
<div class="modal" id="importModal">
    <div class="modal-content">
        <div class="modal-header">ğŸ“¤ å¯¼å…¥é”™é¢˜æœ¬</div>
        <div class="form-group">
            <label>ç²˜è´´JSONæ ¼å¼çš„é”™é¢˜æœ¬æ•°æ®ï¼š</label>
            <textarea id="importData" rows="10" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; font-family: monospace; box-sizing: border-box; resize: vertical;"></textarea>
            <div class="hint">ğŸ’¡ æç¤ºï¼šä»å¯¼å‡ºåŠŸèƒ½è·å–çš„JSONæ•°æ®ï¼Œç›´æ¥ç²˜è´´åˆ°è¿™é‡Œå³å¯</div>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" id="importMerge" checked> 
                åˆå¹¶åˆ°ç°æœ‰é”™é¢˜æœ¬ï¼ˆä¸å‹¾é€‰å°†æ›¿æ¢å…¨éƒ¨ï¼‰
            </label>
        </div>
        <div class="modal-actions">
            <button class="btn-outline" onclick="closeImportModal()">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="doImport()">å¯¼å…¥</button>
        </div>
    </div>
</div>

<!-- éšè—çš„æ–‡ä»¶è¾“å…¥ç”¨äºå¯¼å…¥ -->
<input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">

<script>
    // === æ•°æ®å­˜å‚¨ ===
    const STORAGE_KEY = 'pte_dictation_notebook';
    let notebook = [];
    let currentQuestion = null;
    let isAnswered = false;
    let isPlaying = false;
    let currentUtterance = null;

    // === ç¤ºä¾‹æ•°æ® ===
    const SAMPLE_DATA = [
        { text: 'convenient' },
        { text: 'important' },
        { text: 'difficult' },
        { text: 'beautiful' },
        { text: 'intelligent' },
        { text: 'make a difference' },
        { text: 'take into account' },
        { text: 'It is very convenient.' },
        { text: 'This is important.' },
        { text: 'I need to make a decision.' }
    ];

    // === è¯­éŸ³åˆæˆ ===
    function playAudio() {
        if (!currentQuestion) {
            alert('è¯·å…ˆæ·»åŠ å¬å†™å†…å®¹æˆ–åŠ è½½ç¤ºä¾‹æ•°æ®');
            return;
        }

        if (isPlaying) {
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåœæ­¢æ’­æ”¾
            stopAudio();
            return;
        }

        const text = currentQuestion.text;
        if (!text) {
            alert('å½“å‰é¢˜ç›®æ²¡æœ‰å†…å®¹');
            return;
        }

        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³åˆæˆ
        if (!('speechSynthesis' in window)) {
            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨');
            return;
        }

        // åœæ­¢ä¹‹å‰çš„æ’­æ”¾
        window.speechSynthesis.cancel();

        // åˆ›å»ºè¯­éŸ³åˆæˆå¯¹è±¡
        const utterance = new SpeechSynthesisUtterance(text);
        
        // è®¾ç½®è¯­éŸ³å‚æ•°
        utterance.lang = 'en-US';
        utterance.rate = 0.9; // è¯­é€Ÿï¼ˆ0.1-10ï¼Œé»˜è®¤1ï¼‰
        utterance.pitch = 1; // éŸ³è°ƒï¼ˆ0-2ï¼Œé»˜è®¤1ï¼‰
        utterance.volume = 1; // éŸ³é‡ï¼ˆ0-1ï¼Œé»˜è®¤1ï¼‰

        // å°è¯•é€‰æ‹©è‹±å¼æˆ–ç¾å¼è‹±è¯­è¯­éŸ³
        const voices = window.speechSynthesis.getVoices();
        const englishVoice = voices.find(voice => 
            voice.lang.startsWith('en') && 
            (voice.name.includes('US') || voice.name.includes('UK') || voice.name.includes('English'))
        );
        if (englishVoice) {
            utterance.voice = englishVoice;
        }

        // æ’­æ”¾å¼€å§‹
        utterance.onstart = function() {
            isPlaying = true;
            updatePlayButton(true);
        };

        // æ’­æ”¾ç»“æŸ
        utterance.onend = function() {
            isPlaying = false;
            updatePlayButton(false);
        };

        // æ’­æ”¾é”™è¯¯
        utterance.onerror = function(event) {
            isPlaying = false;
            updatePlayButton(false);
            console.error('è¯­éŸ³åˆæˆé”™è¯¯:', event);
            alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•');
        };

        currentUtterance = utterance;
        window.speechSynthesis.speak(utterance);
    }

    function stopAudio() {
        if (window.speechSynthesis) {
            window.speechSynthesis.cancel();
        }
        isPlaying = false;
        updatePlayButton(false);
    }

    function updatePlayButton(playing) {
        const btn = document.getElementById('playButton');
        if (playing) {
            btn.innerHTML = 'â¸';
            btn.classList.add('playing');
            btn.disabled = false;
        } else {
            btn.innerHTML = 'â–¶';
            btn.classList.remove('playing');
            btn.disabled = false;
        }
    }

    // ç¡®ä¿è¯­éŸ³åˆ—è¡¨åŠ è½½å®Œæˆï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ï¼‰
    if ('speechSynthesis' in window) {
        // Chromeéœ€è¦ç­‰å¾…voiceschangedäº‹ä»¶
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = function() {
                // è¯­éŸ³åˆ—è¡¨å·²åŠ è½½
            };
        }
    }

    // === æƒé‡ç³»ç»Ÿï¼ˆæ”¹è¿›ç‰ˆï¼šå‚è€ƒQuizletå’Œç™¾è¯æ–©çš„é—´éš”é‡å¤ç®—æ³•ï¼‰===
    function initQuestionStats(question) {
        if (!question.correctCount) question.correctCount = 0;
        if (!question.wrongCount) question.wrongCount = 0;
        if (!question.consecutiveCorrect) question.consecutiveCorrect = 0; // è¿ç»­æ­£ç¡®æ¬¡æ•°
        if (!question.lastSeenTime) question.lastSeenTime = 0; // ä¸Šæ¬¡å‡ºç°æ—¶é—´
        return question;
    }

    function calculateWeight(question) {
        // æ”¹è¿›çš„æƒé‡ç®—æ³•ï¼šæ›´æ¸©å’Œçš„æƒ©ç½šå’Œå¥–åŠ±æœºåˆ¶
        // 1. åŸºç¡€æƒé‡
        const baseWeight = 1;
        
        // 2. é”™è¯¯æƒ©ç½šï¼ˆé™ä½æƒ©ç½šåŠ›åº¦ï¼šä»+2æ”¹ä¸º+0.8ï¼‰
        // ä½¿ç”¨å¹³æ–¹æ ¹å‡½æ•°ï¼Œé¿å…é”™è¯¯æ¬¡æ•°è¿‡å¤šæ—¶æƒé‡çˆ†ç‚¸
        const wrongWeight = Math.sqrt(question.wrongCount) * 0.8;
        
        // 3. æ­£ç¡®å¥–åŠ±ï¼ˆå¢åŠ å¥–åŠ±åŠ›åº¦ï¼šä»-0.5æ”¹ä¸º-1.2ï¼‰
        // è¿ç»­æ­£ç¡®æœ‰é¢å¤–å¥–åŠ±
        const correctReward = question.correctCount * 1.2;
        const consecutiveBonus = Math.min(question.consecutiveCorrect * 0.5, 3); // è¿ç»­æ­£ç¡®é¢å¤–å¥–åŠ±ï¼Œæœ€å¤š+3
        
        // 4. æ—¶é—´è¡°å‡ï¼šå¦‚æœå¾ˆä¹…æ²¡å‡ºç°ï¼Œé™ä½æƒé‡ï¼ˆé¿å…ä¸€ç›´ä¸å‡ºç°ï¼‰
        const now = Date.now();
        const daysSinceLastSeen = (now - (question.lastSeenTime || 0)) / (1000 * 60 * 60 * 24);
        const timeDecay = Math.min(daysSinceLastSeen * 0.1, 2); // æ¯å¤©è¡°å‡0.1ï¼Œæœ€å¤šè¡°å‡2
        
        // 5. è®¡ç®—æœ€ç»ˆæƒé‡
        const weight = Math.max(0.1, baseWeight + wrongWeight - correctReward - consecutiveBonus - timeDecay);
        
        return weight;
    }

    function selectWeightedQuestion() {
        if (notebook.length === 0) return null;
        
        // é¿å…è¿ç»­å‡ºç°åŒä¸€é¢˜ï¼šå¦‚æœå½“å‰é¢˜ç›®å­˜åœ¨ä¸”æœ€è¿‘åˆšå‡ºç°è¿‡ï¼Œé™ä½å…¶æƒé‡
        const now = Date.now();
        const recentThreshold = 10000; // 10ç§’å†…ç®—"æœ€è¿‘"
        
        // è®¡ç®—æ€»æƒé‡
        let totalWeight = 0;
        const weights = notebook.map(q => {
            let weight = calculateWeight(q);
            
            // å¦‚æœè¿™ä¸ªé¢˜ç›®æœ€è¿‘åˆšå‡ºç°è¿‡ï¼Œå¤§å¹…é™ä½æƒé‡ï¼ˆé¿å…è¿ç»­å‡ºç°ï¼‰
            if (currentQuestion && q === currentQuestion) {
                const timeSinceLastSeen = now - (q.lastSeenTime || 0);
                if (timeSinceLastSeen < recentThreshold) {
                    weight *= 0.1; // é™ä½åˆ°10%ï¼Œå‡ ä¹ä¸ä¼šé€‰ä¸­
                }
            }
            
            totalWeight += weight;
            return weight;
        });
        
        // åŠ æƒéšæœºé€‰æ‹©
        let random = Math.random() * totalWeight;
        for (let i = 0; i < notebook.length; i++) {
            random -= weights[i];
            if (random <= 0) {
                const selected = notebook[i];
                // æ›´æ–°å‡ºç°æ—¶é—´
                selected.lastSeenTime = now;
                return selected;
            }
        }
        
        // å¦‚æœå‡ºé—®é¢˜ï¼Œè¿”å›æœ€åä¸€ä¸ªï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼‰
        const selected = notebook[notebook.length - 1];
        selected.lastSeenTime = now;
        return selected;
    }

    // === åˆå§‹åŒ– ===
    function init() {
        loadNotebook();
        if (notebook.length > 0) {
            nextQuestion();
        } else {
            document.getElementById('playHint').innerText = 'æš‚æ— é¢˜ç›®ï¼Œè¯·å…ˆæ·»åŠ å¬å†™å†…å®¹æˆ–åŠ è½½ç¤ºä¾‹æ•°æ®';
            document.getElementById('playButton').disabled = true;
            document.getElementById('dictationInput').disabled = true;
            document.getElementById('checkBtn').disabled = true;
        }
        updateNotebookDisplay();
    }

    function loadSampleData() {
        if (notebook.length > 0) {
            if (!confirm('å½“å‰å·²æœ‰å¬å†™å†…å®¹ï¼ŒåŠ è½½ç¤ºä¾‹æ•°æ®å°†åˆå¹¶åˆ°ç°æœ‰é”™é¢˜æœ¬ä¸­ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                return;
            }
        }
        
        SAMPLE_DATA.forEach(item => {
            const existingIndex = notebook.findIndex(n => n.text.toLowerCase().trim() === item.text.toLowerCase().trim());
            if (existingIndex > -1) {
                // å·²å­˜åœ¨ï¼Œä¿ç•™ç°æœ‰ç»Ÿè®¡
            } else {
                notebook.push({
                    text: item.text,
                    correctCount: 0,
                    wrongCount: 0
                });
            }
        });
        
        saveNotebook();
        updateNotebookDisplay();
        
        if (!currentQuestion) {
            nextQuestion();
        }
        
        alert(`âœ… å·²åŠ è½½ ${SAMPLE_DATA.length} æ¡ç¤ºä¾‹æ•°æ®ï¼`);
        closeNotebookModal();
    }

    // === é”™é¢˜æœ¬ç®¡ç† ===
    function loadNotebook() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try {
                notebook = JSON.parse(stored);
                notebook = notebook.map(q => initQuestionStats(q));
            } catch (e) {
                notebook = [];
            }
        }
    }

    function saveNotebook() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(notebook));
        updateNotebookDisplay();
    }

    let showStats = false;

    function updateNotebookDisplay() {
        const modalList = document.getElementById('notebookModalList');
        const countEl = document.getElementById('notebookCount');
        
        if (countEl) {
            countEl.textContent = notebook.length;
        }
        
        if (notebook.length === 0) {
            if (modalList) {
                modalList.innerHTML = '<div class="notebook-empty">æš‚æ— å¬å†™å†…å®¹</div>';
            }
            return;
        }
        
        let html = '';
        notebook.forEach((item, index) => {
            const statsClass = showStats ? '' : 'hidden';
            const correctCount = item.correctCount || 0;
            const wrongCount = item.wrongCount || 0;
            const totalCount = correctCount + wrongCount;
            const accuracy = totalCount > 0 ? ((correctCount / totalCount) * 100).toFixed(0) : 0;
            
            html += `
                <div class="notebook-item">
                    <div class="notebook-item-content">
                        <div class="notebook-item-text">${item.text}</div>
                        <div class="notebook-item-stats ${statsClass}">
                            <span class="stat-correct">âœ“ ${correctCount}</span> | 
                            <span class="stat-wrong">âœ— ${wrongCount}</span>
                            ${totalCount > 0 ? ` | æ­£ç¡®ç‡: ${accuracy}%` : ''}
                        </div>
                    </div>
                    <div class="notebook-item-actions">
                        <button class="btn-outline btn-small" onclick="useQuestion(${index})">ä½¿ç”¨</button>
                        <button class="btn-danger btn-small" onclick="deleteQuestion(${index})">åˆ é™¤</button>
                    </div>
                </div>
            `;
        });
        
        if (modalList) {
            modalList.innerHTML = html;
        }
    }

    function toggleStats() {
        showStats = !showStats;
        const btn = document.getElementById('toggleStatsBtn');
        const stats = document.querySelectorAll('.notebook-item-stats');
        
        if (showStats) {
            btn.textContent = 'éšè—ç»Ÿè®¡';
            stats.forEach(el => el.classList.remove('hidden'));
        } else {
            btn.textContent = 'æ˜¾ç¤ºç»Ÿè®¡';
            stats.forEach(el => el.classList.add('hidden'));
        }
    }

    function addToNotebook() {
        const text = document.getElementById('addText').value.trim();
        
        if (!text) {
            alert('è¯·è¾“å…¥å¬å†™å†…å®¹');
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼Œå¿½ç•¥é¦–å°¾ç©ºæ ¼ï¼‰
        const existingIndex = notebook.findIndex(item => 
            item.text.toLowerCase().trim() === text.toLowerCase().trim()
        );
        if (existingIndex > -1) {
            alert('è¯¥å†…å®¹å·²å­˜åœ¨');
            return;
        }
        
        notebook.push({
            text: text,
            correctCount: 0,
            wrongCount: 0
        });
        
        saveNotebook();
        
        // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œä¿æŒæ¨¡æ€æ¡†æ‰“å¼€ï¼Œæ–¹ä¾¿ç»§ç»­æ·»åŠ 
        document.getElementById('addText').value = '';
        document.getElementById('addText').focus();
        
        if (!currentQuestion) {
            useQuestion(notebook.length - 1);
        }
    }

    function deleteQuestion(index) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¬å†™å†…å®¹å—ï¼Ÿ')) {
            const deletedQuestion = notebook[index];
            notebook.splice(index, 1);
            saveNotebook();
            if (currentQuestion && currentQuestion === deletedQuestion) {
                currentQuestion = null;
                nextQuestion();
            }
        }
    }

    function useQuestion(index) {
        if (index >= 0 && index < notebook.length) {
            currentQuestion = notebook[index];
            resetQuestion();
            closeNotebookModal();
        }
    }

    function openAddModal() {
        // å¦‚æœé”™é¢˜æœ¬æ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œå…ˆå…³é—­å®ƒ
        const notebookModal = document.getElementById('notebookModal');
        if (notebookModal && notebookModal.classList.contains('show')) {
            closeNotebookModal();
        }
        document.getElementById('addModal').classList.add('show');
        document.getElementById('addText').value = '';
        document.getElementById('addText').focus();
    }

    function closeAddModal() {
        document.getElementById('addModal').classList.remove('show');
    }

    function openNotebookModal() {
        showStats = false;
        const statsBtn = document.getElementById('toggleStatsBtn');
        if (statsBtn) {
            statsBtn.textContent = 'æ˜¾ç¤ºç»Ÿè®¡';
        }
        updateNotebookDisplay();
        document.getElementById('notebookModal').classList.add('show');
    }

    function closeNotebookModal() {
        document.getElementById('notebookModal').classList.remove('show');
    }

    // === å¯¼å‡º/å¯¼å…¥åŠŸèƒ½ ===
    function exportNotebook() {
        if (notebook.length === 0) {
            alert('é”™é¢˜æœ¬ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º');
            return;
        }
        
        const dataStr = JSON.stringify(notebook, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `pte_dictation_notebook_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        navigator.clipboard.writeText(dataStr).then(() => {
            alert('âœ… é”™é¢˜æœ¬å·²å¯¼å‡ºå¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\næ–‡ä»¶åï¼š' + link.download);
        }).catch(() => {
            alert('âœ… é”™é¢˜æœ¬å·²å¯¼å‡ºï¼\n\næ–‡ä»¶åï¼š' + link.download);
        });
    }

    function importNotebook() {
        const useFile = confirm('é€‰æ‹©å¯¼å…¥æ–¹å¼ï¼š\n\nç¡®å®š = é€‰æ‹©æ–‡ä»¶\nå–æ¶ˆ = ç²˜è´´æ–‡æœ¬');
        if (useFile) {
            document.getElementById('fileInput').click();
        } else {
            document.getElementById('importModal').classList.add('show');
            document.getElementById('importData').value = '';
            document.getElementById('importData').focus();
        }
    }

    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (Array.isArray(imported)) {
                    doImportWithData(imported, true);
                } else {
                    alert('âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šå¿…é¡»æ˜¯JSONæ•°ç»„æ ¼å¼');
                }
            } catch (error) {
                alert('âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼š' + error.message);
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    function doImport() {
        const dataStr = document.getElementById('importData').value.trim();
        if (!dataStr) {
            alert('è¯·è¾“å…¥è¦å¯¼å…¥çš„æ•°æ®');
            return;
        }
        
        try {
            const imported = JSON.parse(dataStr);
            if (!Array.isArray(imported)) {
                alert('âŒ æ•°æ®æ ¼å¼é”™è¯¯ï¼šå¿…é¡»æ˜¯JSONæ•°ç»„æ ¼å¼');
                return;
            }
            
            const merge = document.getElementById('importMerge').checked;
            doImportWithData(imported, merge);
        } catch (error) {
            alert('âŒ æ•°æ®è§£æå¤±è´¥ï¼š' + error.message);
        }
    }

    function doImportWithData(imported, merge) {
        if (merge) {
            imported.forEach(item => {
                if (item.text) {
                    const existingIndex = notebook.findIndex(n => 
                        n.text.toLowerCase().trim() === item.text.toLowerCase().trim()
                    );
                    if (existingIndex > -1) {
                        // ä¿ç•™ç°æœ‰ç»Ÿè®¡ï¼Œå¦‚æœå¯¼å…¥æ•°æ®æœ‰ç»Ÿè®¡åˆ™åˆå¹¶
                        if (item.correctCount !== undefined) {
                            notebook[existingIndex].correctCount = (notebook[existingIndex].correctCount || 0) + (item.correctCount || 0);
                        }
                        if (item.wrongCount !== undefined) {
                            notebook[existingIndex].wrongCount = (notebook[existingIndex].wrongCount || 0) + (item.wrongCount || 0);
                        }
                    } else {
                        notebook.push({
                            text: item.text,
                            correctCount: item.correctCount || 0,
                            wrongCount: item.wrongCount || 0
                        });
                    }
                }
            });
            alert(`âœ… æˆåŠŸå¯¼å…¥å¹¶åˆå¹¶ ${imported.length} æ¡å¬å†™è®°å½•ï¼`);
        } else {
            notebook = imported.map(item => ({
                text: item.text,
                correctCount: item.correctCount || 0,
                wrongCount: item.wrongCount || 0
            }));
            alert(`âœ… æˆåŠŸå¯¼å…¥ ${notebook.length} æ¡å¬å†™è®°å½•ï¼ˆå·²æ›¿æ¢åŸæœ‰æ•°æ®ï¼‰ï¼`);
        }
        
        saveNotebook();
        closeImportModal();
        updateNotebookDisplay();
        
        if (!currentQuestion && notebook.length > 0) {
            nextQuestion();
        }
    }

    function clearNotebook() {
        if (notebook.length === 0) {
            alert('é”™é¢˜æœ¬å·²ç»æ˜¯ç©ºçš„äº†');
            return;
        }
        
        if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${notebook.length} æ¡å¬å†™è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            notebook = [];
            saveNotebook();
            updateNotebookDisplay();
            currentQuestion = null;
            document.getElementById('playHint').innerText = 'æš‚æ— é¢˜ç›®ï¼Œè¯·å…ˆæ·»åŠ å¬å†™å†…å®¹';
            document.getElementById('playButton').disabled = true;
            document.getElementById('dictationInput').disabled = true;
            document.getElementById('checkBtn').disabled = true;
            alert('âœ… é”™é¢˜æœ¬å·²æ¸…ç©º');
        }
    }

    function closeImportModal() {
        document.getElementById('importModal').classList.remove('show');
        document.getElementById('importData').value = '';
    }

    document.getElementById('importModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeImportModal();
        }
    });

    // === é¢˜ç›®é€»è¾‘ ===
    function nextQuestion() {
        if (notebook.length === 0) {
            document.getElementById('playHint').innerText = 'æš‚æ— é¢˜ç›®ï¼Œè¯·å…ˆæ·»åŠ å¬å†™å†…å®¹';
            document.getElementById('playButton').disabled = true;
            document.getElementById('dictationInput').disabled = true;
            document.getElementById('checkBtn').disabled = true;
            return;
        }
        
        currentQuestion = selectWeightedQuestion();
        resetQuestion();
    }

    function resetQuestion() {
        isAnswered = false;
        stopAudio();
        document.getElementById('playHint').innerText = 'ç‚¹å‡»æ’­æ”¾æŒ‰é’®ï¼Œå¬å†™å•è¯/çŸ­è¯­/å¥å­';
        document.getElementById('dictationInput').value = '';
        document.getElementById('dictationInput').disabled = false;
        document.getElementById('dictationInput').focus();
        document.getElementById('checkBtn').style.display = 'inline-block';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('feedbackArea').style.display = 'none';
        document.getElementById('playButton').disabled = false;
    }

    function checkAnswer() {
        if (isAnswered || !currentQuestion) return;
        
        const userAnswer = document.getElementById('dictationInput').value.trim();
        if (!userAnswer) {
            alert('è¯·è¾“å…¥ç­”æ¡ˆ');
            return;
        }
        
        const correctText = currentQuestion.text.trim();
        // ä¸åŒºåˆ†å¤§å°å†™æ¯”è¾ƒ
        const isCorrect = correctText.toLowerCase() === userAnswer.toLowerCase();
        
        updateQuestionStats(currentQuestion, isCorrect);
        
        showFeedback(isCorrect, userAnswer, correctText);
        isAnswered = true;
        document.getElementById('dictationInput').disabled = true;
        document.getElementById('checkBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'inline-block';
        
        saveNotebook();
    }

    function updateQuestionStats(question, isCorrect) {
        // ç¡®ä¿ç»Ÿè®¡å­—æ®µå­˜åœ¨
        initQuestionStats(question);
        
        if (isCorrect) {
            question.correctCount++;
            question.consecutiveCorrect = (question.consecutiveCorrect || 0) + 1;
            // è¿ç»­ç­”å¯¹3æ¬¡åï¼Œé”™è¯¯æ¬¡æ•°å‡åŠï¼ˆç»™ç”¨æˆ·ä¸€ä¸ª"æ”¹è¿‡è‡ªæ–°"çš„æœºä¼šï¼‰
            if (question.consecutiveCorrect >= 3 && question.wrongCount > 0) {
                question.wrongCount = Math.max(0, Math.floor(question.wrongCount * 0.5));
            }
        } else {
            question.wrongCount++;
            question.consecutiveCorrect = 0; // é‡ç½®è¿ç»­æ­£ç¡®è®¡æ•°
        }
        
        // æ›´æ–°å‡ºç°æ—¶é—´
        question.lastSeenTime = Date.now();
    }

    function showFeedback(isCorrect, userAnswer, correctText) {
        const fbBox = document.getElementById('feedbackArea');
        fbBox.style.display = 'block';
        fbBox.className = 'feedback-box ' + (isCorrect ? 'feedback-correct' : 'feedback-wrong');
        
        let html = `<h3>${isCorrect ? 'âœ… å›ç­”æ­£ç¡®!' : 'âŒ å›ç­”é”™è¯¯'}</h3>`;
        html += `<p><strong>ä½ çš„ç­”æ¡ˆ:</strong> "${userAnswer}"</p>`;
        html += `<div class="answers">`;
        html += `<strong>æ­£ç¡®ç­”æ¡ˆ:</strong> `;
        html += `<span class="answer-item">${correctText}</span>`;
        html += `</div>`;
        
        fbBox.innerHTML = html;
    }

    document.getElementById('addModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeAddModal();
        }
    });

    document.getElementById('notebookModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeNotebookModal();
        }
    });

    // é¡µé¢å¸è½½æ—¶åœæ­¢æ’­æ”¾
    window.addEventListener('beforeunload', function() {
        stopAudio();
    });

    // åˆå§‹åŒ–
    window.addEventListener('load', init);
</script>

</body>
</html>
