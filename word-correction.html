<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>å•è¯çº é”™ - PTEç»ƒä¹ ç½‘ç«™</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --error: #dc2626;
            --bg: #f8fafc;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .nav-link:hover {
            background: #f1f5f9;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
            box-sizing: border-box;
            margin-top: 60px;
        }
        h1 { 
            margin-top: 0; 
            color: #333;
            font-size: 1.8rem;
        }
        
        .chinese-display {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            margin: 30px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-section {
            margin: 30px 0;
        }
        .english-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.2rem;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            text-align: center;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .english-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .english-input:disabled {
            background: #f1f5f9;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: all 0.2s;
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        .btn-primary:hover { 
            background: #1d4ed8; 
        }
        .btn-primary:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .btn-outline { 
            border: 2px solid #cbd5e1; 
            background: transparent; 
        }
        .btn-outline:hover {
            background: #f1f5f9;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-success:hover {
            background: #15803d;
        }
        
        .feedback-box {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background: #f1f5f9;
            text-align: left;
            display: none;
        }
        .feedback-correct { 
            border-left: 5px solid var(--success); 
            background: #f0fdf4;
        }
        .feedback-wrong { 
            border-left: 5px solid var(--error); 
            background: #fef2f2;
        }
        .feedback-box h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .feedback-box .answers {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .feedback-box .answers strong {
            color: var(--primary);
        }
        .answer-item {
            display: inline-block;
            margin: 5px 10px 5px 0;
            padding: 5px 12px;
            background: #e0e7ff;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        /* é”™é¢˜æœ¬ç®¡ç† */
        .notebook-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .notebook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .notebook-title {
            font-size: 1rem;
            font-weight: bold;
            color: #666;
        }
        .notebook-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            text-align: left;
        }
        .notebook-item {
            padding: 10px 15px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notebook-item-content {
            flex: 1;
        }
        .notebook-item-chinese {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .notebook-item-english {
            color: #64748b;
            font-size: 0.9rem;
        }
        .notebook-item-english.hidden {
            display: none;
        }
        .notebook-item-stats {
            color: #94a3b8;
            font-size: 0.75rem;
            margin-top: 4px;
        }
        .notebook-item-stats.hidden {
            display: none;
        }
        .notebook-item-stats .stat-correct {
            color: var(--success);
        }
        .notebook-item-stats .stat-wrong {
            color: var(--error);
        }
        .toggle-answer-btn {
            font-size: 0.75rem;
            padding: 3px 8px;
            min-height: auto;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
        }
        .toggle-answer-btn:hover {
            background: #e2e8f0;
        }
        .notebook-item-actions {
            display: flex;
            gap: 5px;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
            min-height: auto;
        }
        .btn-danger {
            background: var(--error);
            color: white;
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        .notebook-empty {
            text-align: center;
            color: #94a3b8;
            padding: 20px;
            font-size: 0.9rem;
        }

        /* æ–°å¢é”™é¢˜æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #333;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .form-group .hint {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.9rem;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        .answer-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .answer-input-group input {
            flex: 1;
        }
        .add-answer-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
            min-height: auto;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media screen and (max-width: 768px) {
            .container {
                padding: 1.5rem;
                margin: 10px;
                margin-top: 70px;
            }
            h1 {
                font-size: 1.5rem;
            }
            .chinese-display {
                font-size: 2.5rem;
                margin: 20px 0;
            }
        }

        @media screen and (max-width: 480px) {
            body {
                padding: 10px;
            }
            .nav-bar {
                padding: 8px 15px;
                font-size: 0.85rem;
            }
            .container {
                padding: 1rem;
                border-radius: 0.75rem;
                margin-top: 60px;
            }
            h1 {
                font-size: 1.3rem;
                margin-bottom: 10px;
            }
            .chinese-display {
                font-size: 2rem;
                margin: 15px 0;
                min-height: 60px;
            }
            .english-input {
                font-size: 1rem;
                padding: 12px 15px;
            }
            .controls {
                flex-direction: column;
                gap: 8px;
            }
            button {
                width: 100%;
                padding: 14px 20px;
                font-size: 0.95rem;
            }
            .modal-content {
                padding: 1.5rem;
            }
            .modal-header {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>

<nav class="nav-bar">
    <a href="index.html" class="nav-link">ğŸ  è¿”å›ä¸»é¡µ</a>
    <span style="color: #64748b; font-size: 0.9rem;">ğŸ“ å•è¯çº é”™</span>
</nav>

<div class="container">
    <h1>ğŸ“ å•è¯çº é”™ç»ƒä¹ </h1>
    
    <div class="chinese-display" id="chineseDisplay">---</div>
    
    <div class="input-section">
        <input 
            type="text" 
            id="englishInput" 
            class="english-input" 
            placeholder="è¯·è¾“å…¥å¯¹åº”çš„è‹±æ–‡å•è¯..."
            autocomplete="off"
            onkeypress="if(event.key==='Enter') checkAnswer()"
        >
    </div>

    <div class="controls">
        <button class="btn-primary" onclick="checkAnswer()" id="checkBtn">æ£€æŸ¥ç­”æ¡ˆ</button>
        <button class="btn-outline" onclick="nextQuestion()" id="nextBtn" style="display: none;">ä¸‹ä¸€é¢˜</button>
        <button class="btn-outline" onclick="openNotebookModal()">ğŸ“š é”™é¢˜æœ¬</button>
    </div>

    <div class="feedback-box" id="feedbackArea"></div>
</div>

<!-- æ–°å¢é”™é¢˜æ¨¡æ€æ¡† -->
<div class="modal" id="addModal">
    <div class="modal-content">
        <div class="modal-header">æ–°å¢é”™é¢˜</div>
        <div class="form-group">
            <label>ä¸­æ–‡ï¼š</label>
            <input type="text" id="addChinese" placeholder="ä¾‹å¦‚ï¼šæ–¹ä¾¿">
        </div>
        <div class="form-group">
            <label>è‹±æ–‡ç­”æ¡ˆï¼ˆå¯å¤šä¸ªï¼Œç”¨é€—å·åˆ†éš”æˆ–æ¯è¡Œä¸€ä¸ªï¼‰ï¼š</label>
            <input type="text" id="addEnglish" placeholder="ä¾‹å¦‚ï¼šconvenient, handy">
            <div class="hint">ğŸ’¡ æç¤ºï¼šå¯ä»¥è¾“å…¥å¤šä¸ªç­”æ¡ˆï¼Œç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”</div>
        </div>
        <div class="modal-actions">
            <button class="btn-outline" onclick="closeAddModal()">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="addToNotebook()">æ·»åŠ </button>
        </div>
    </div>
</div>

<!-- é”™é¢˜æœ¬æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div class="modal" id="notebookModal">
    <div class="modal-content">
        <div class="modal-header">ğŸ“š é”™é¢˜æœ¬ç®¡ç†</div>
        <div style="margin-bottom: 1rem; display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn-primary" onclick="closeNotebookModal(); openAddModal();" style="flex: 1; min-width: 120px;">+ æ–°å¢é”™é¢˜</button>
            <button class="btn-outline" onclick="loadSampleData()" style="flex: 1; min-width: 100px;">ğŸ“‹ ç¤ºä¾‹æ•°æ®</button>
            <button class="btn-outline" onclick="exportNotebook()" style="flex: 1; min-width: 100px;">ğŸ“¥ å¯¼å‡º</button>
            <button class="btn-outline" onclick="importNotebook()" style="flex: 1; min-width: 100px;">ğŸ“¤ å¯¼å…¥</button>
            <button class="btn-danger" onclick="clearNotebook()" style="flex: 1; min-width: 100px;">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        <div style="margin-bottom: 1rem; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 0.85rem; color: #0369a1;">
            ğŸ’¡ æç¤ºï¼šé”™é¢˜æœ¬æ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ã€‚å¯ä»¥å¯¼å‡ºå¤‡ä»½æˆ–å¯¼å…¥ä»–äººçš„é”™é¢˜æœ¬ã€‚
        </div>
        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
            <span style="font-size: 0.9rem; color: #64748b;">å…± <strong id="notebookCount">0</strong> æ¡é”™é¢˜</span>
            <div style="display: flex; gap: 8px;">
                <button class="toggle-answer-btn" onclick="toggleStats()" id="toggleStatsBtn">æ˜¾ç¤ºç»Ÿè®¡</button>
                <button class="toggle-answer-btn" onclick="toggleAnswers()" id="toggleAnswerBtn">æ˜¾ç¤ºç­”æ¡ˆ</button>
            </div>
        </div>
        <div class="notebook-list" id="notebookModalList">
            <div class="notebook-empty">æš‚æ— é”™é¢˜è®°å½•</div>
        </div>
        <div class="modal-actions">
            <button class="btn-outline" onclick="closeNotebookModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- å¯¼å…¥é”™é¢˜æœ¬æ¨¡æ€æ¡† -->
<div class="modal" id="importModal">
    <div class="modal-content">
        <div class="modal-header">ğŸ“¤ å¯¼å…¥é”™é¢˜æœ¬</div>
        <div class="form-group">
            <label>ç²˜è´´JSONæ ¼å¼çš„é”™é¢˜æœ¬æ•°æ®ï¼š</label>
            <textarea id="importData" rows="10" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; font-family: monospace; box-sizing: border-box; resize: vertical;"></textarea>
            <div class="hint">ğŸ’¡ æç¤ºï¼šä»å¯¼å‡ºåŠŸèƒ½è·å–çš„JSONæ•°æ®ï¼Œç›´æ¥ç²˜è´´åˆ°è¿™é‡Œå³å¯</div>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" id="importMerge" checked> 
                åˆå¹¶åˆ°ç°æœ‰é”™é¢˜æœ¬ï¼ˆä¸å‹¾é€‰å°†æ›¿æ¢å…¨éƒ¨ï¼‰
            </label>
        </div>
        <div class="modal-actions">
            <button class="btn-outline" onclick="closeImportModal()">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="doImport()">å¯¼å…¥</button>
        </div>
    </div>
</div>

<!-- éšè—çš„æ–‡ä»¶è¾“å…¥ç”¨äºå¯¼å…¥ -->
<input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">

<script>
    // === æ•°æ®å­˜å‚¨ ===
    const STORAGE_KEY = 'pte_word_notebook';
    let notebook = [];
    let currentQuestion = null;
    let isAnswered = false;

    // === ç¤ºä¾‹æ•°æ® ===
    const SAMPLE_DATA = [
        { chinese: 'æ–¹ä¾¿', english: ['convenient', 'handy'] },
        { chinese: 'é‡è¦', english: ['important', 'significant', 'crucial'] },
        { chinese: 'å›°éš¾', english: ['difficult', 'hard', 'challenging'] },
        { chinese: 'ç¾ä¸½', english: ['beautiful', 'pretty', 'gorgeous'] },
        { chinese: 'èªæ˜', english: ['smart', 'clever', 'intelligent'] },
        { chinese: 'æˆåŠŸ', english: ['success', 'achievement'] },
        { chinese: 'å¤±è´¥', english: ['failure', 'defeat'] },
        { chinese: 'æœºä¼š', english: ['opportunity', 'chance'] },
        { chinese: 'å†³å®š', english: ['decide', 'determine'] },
        { chinese: 'å»ºè®®', english: ['suggest', 'recommend', 'advise'] }
    ];

    // === æƒé‡ç³»ç»Ÿ ===
    function initQuestionStats(question) {
        if (!question.correctCount) question.correctCount = 0;
        if (!question.wrongCount) question.wrongCount = 0;
        return question;
    }

    function calculateWeight(question) {
        // æƒé‡è®¡ç®—ï¼šé”™è¯¯æ¬¡æ•°è¶Šå¤šï¼Œæƒé‡è¶Šé«˜ï¼›æ­£ç¡®æ¬¡æ•°è¶Šå¤šï¼Œæƒé‡è¶Šä½
        // åŸºç¡€æƒé‡ä¸º1ï¼Œæ¯é”™1æ¬¡+2ï¼Œæ¯å¯¹1æ¬¡-0.5
        const baseWeight = 1;
        const wrongWeight = question.wrongCount * 2;
        const correctPenalty = question.correctCount * 0.5;
        return Math.max(0.1, baseWeight + wrongWeight - correctPenalty); // æœ€å°æƒé‡0.1
    }

    function selectWeightedQuestion() {
        if (notebook.length === 0) return null;
        
        // è®¡ç®—æ€»æƒé‡
        let totalWeight = 0;
        const weights = notebook.map(q => {
            const weight = calculateWeight(q);
            totalWeight += weight;
            return weight;
        });
        
        // åŠ æƒéšæœºé€‰æ‹©
        let random = Math.random() * totalWeight;
        for (let i = 0; i < notebook.length; i++) {
            random -= weights[i];
            if (random <= 0) {
                return notebook[i];
            }
        }
        
        // å¦‚æœå‡ºé—®é¢˜ï¼Œè¿”å›æœ€åä¸€ä¸ªï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼‰
        return notebook[notebook.length - 1];
    }

    // === åˆå§‹åŒ– ===
    function init() {
        loadNotebook();
        if (notebook.length > 0) {
            nextQuestion();
        } else {
            document.getElementById('chineseDisplay').innerText = 'æš‚æ— é¢˜ç›®ï¼Œè¯·å…ˆæ·»åŠ é”™é¢˜æˆ–åŠ è½½ç¤ºä¾‹æ•°æ®';
            document.getElementById('englishInput').disabled = true;
            document.getElementById('checkBtn').disabled = true;
        }
        updateNotebookDisplay();
    }

    function loadSampleData() {
        if (notebook.length > 0) {
            if (!confirm('å½“å‰å·²æœ‰é”™é¢˜è®°å½•ï¼ŒåŠ è½½ç¤ºä¾‹æ•°æ®å°†åˆå¹¶åˆ°ç°æœ‰é”™é¢˜æœ¬ä¸­ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                return;
            }
        }
        
        // åˆå¹¶ç¤ºä¾‹æ•°æ®
        SAMPLE_DATA.forEach(item => {
            const existingIndex = notebook.findIndex(n => n.chinese === item.chinese);
            if (existingIndex > -1) {
                // åˆå¹¶ç­”æ¡ˆ
                const existing = notebook[existingIndex];
                notebook[existingIndex].english = [...new Set([...existing.english, ...item.english])];
                // ä¿ç•™ç°æœ‰çš„ç»Ÿè®¡ä¿¡æ¯
            } else {
                // æ·»åŠ æ–°é¡¹
                notebook.push({
                    chinese: item.chinese,
                    english: [...item.english],
                    correctCount: 0,
                    wrongCount: 0
                });
            }
        });
        
        saveNotebook();
        updateNotebookDisplay();
        
        if (!currentQuestion) {
            nextQuestion();
        }
        
        alert(`âœ… å·²åŠ è½½ ${SAMPLE_DATA.length} æ¡ç¤ºä¾‹æ•°æ®ï¼`);
        closeNotebookModal();
    }

    // === é”™é¢˜æœ¬ç®¡ç† ===
    function loadNotebook() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try {
                notebook = JSON.parse(stored);
                // ç¡®ä¿æ‰€æœ‰é¢˜ç›®éƒ½æœ‰æƒé‡å­—æ®µ
                notebook = notebook.map(q => initQuestionStats(q));
            } catch (e) {
                notebook = [];
            }
        }
    }

    function saveNotebook() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(notebook));
        updateNotebookDisplay();
    }

    let showAnswers = false;
    let showStats = false;

    function updateNotebookDisplay() {
        const modalList = document.getElementById('notebookModalList');
        const countEl = document.getElementById('notebookCount');
        
        if (countEl) {
            countEl.textContent = notebook.length;
        }
        
        if (notebook.length === 0) {
            if (modalList) {
                modalList.innerHTML = '<div class="notebook-empty">æš‚æ— é”™é¢˜è®°å½•</div>';
            }
            return;
        }
        
        let html = '';
        notebook.forEach((item, index) => {
            const answers = Array.isArray(item.english) ? item.english : [item.english];
            const answerClass = showAnswers ? '' : 'hidden';
            const statsClass = showStats ? '' : 'hidden';
            const correctCount = item.correctCount || 0;
            const wrongCount = item.wrongCount || 0;
            const totalCount = correctCount + wrongCount;
            const accuracy = totalCount > 0 ? ((correctCount / totalCount) * 100).toFixed(0) : 0;
            
            html += `
                <div class="notebook-item">
                    <div class="notebook-item-content">
                        <div class="notebook-item-chinese">${item.chinese}</div>
                        <div class="notebook-item-english ${answerClass}">${answers.join(', ')}</div>
                        <div class="notebook-item-stats ${statsClass}">
                            <span class="stat-correct">âœ“ ${correctCount}</span> | 
                            <span class="stat-wrong">âœ— ${wrongCount}</span>
                            ${totalCount > 0 ? ` | æ­£ç¡®ç‡: ${accuracy}%` : ''}
                        </div>
                    </div>
                    <div class="notebook-item-actions">
                        <button class="btn-outline btn-small" onclick="useQuestion(${index})">ä½¿ç”¨</button>
                        <button class="btn-danger btn-small" onclick="deleteQuestion(${index})">åˆ é™¤</button>
                    </div>
                </div>
            `;
        });
        
        if (modalList) {
            modalList.innerHTML = html;
        }
    }

    function toggleAnswers() {
        showAnswers = !showAnswers;
        const btn = document.getElementById('toggleAnswerBtn');
        const answers = document.querySelectorAll('.notebook-item-english');
        
        if (showAnswers) {
            btn.textContent = 'éšè—ç­”æ¡ˆ';
            answers.forEach(el => el.classList.remove('hidden'));
        } else {
            btn.textContent = 'æ˜¾ç¤ºç­”æ¡ˆ';
            answers.forEach(el => el.classList.add('hidden'));
        }
    }

    function toggleStats() {
        showStats = !showStats;
        const btn = document.getElementById('toggleStatsBtn');
        const stats = document.querySelectorAll('.notebook-item-stats');
        
        if (showStats) {
            btn.textContent = 'éšè—ç»Ÿè®¡';
            stats.forEach(el => el.classList.remove('hidden'));
        } else {
            btn.textContent = 'æ˜¾ç¤ºç»Ÿè®¡';
            stats.forEach(el => el.classList.add('hidden'));
        }
    }

    function addToNotebook() {
        const chinese = document.getElementById('addChinese').value.trim();
        const english = document.getElementById('addEnglish').value.trim();
        
        if (!chinese) {
            alert('è¯·è¾“å…¥ä¸­æ–‡');
            return;
        }
        
        if (!english) {
            alert('è¯·è¾“å…¥è‹±æ–‡ç­”æ¡ˆ');
            return;
        }
        
        // è§£æè‹±æ–‡ç­”æ¡ˆï¼ˆæ”¯æŒé€—å·ã€æ¢è¡Œã€åˆ†å·åˆ†éš”ï¼‰
        const answers = english
            .split(/[,ï¼Œ;\n]/)
            .map(a => a.trim())
            .filter(a => a.length > 0)
            .map(a => a.toLowerCase());
        
        if (answers.length === 0) {
            alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªè‹±æ–‡ç­”æ¡ˆ');
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const existingIndex = notebook.findIndex(item => item.chinese === chinese);
        if (existingIndex > -1) {
            // åˆå¹¶ç­”æ¡ˆ
            const existing = notebook[existingIndex];
            const merged = [...new Set([...existing.english, ...answers])];
            notebook[existingIndex].english = merged;
            // ä¿ç•™ç°æœ‰çš„ç»Ÿè®¡ä¿¡æ¯
        } else {
            notebook.push({
                chinese: chinese,
                english: answers,
                correctCount: 0,
                wrongCount: 0
            });
        }
        
        saveNotebook();
        
        // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œä¿æŒæ¨¡æ€æ¡†æ‰“å¼€ï¼Œæ–¹ä¾¿ç»§ç»­æ·»åŠ 
        document.getElementById('addChinese').value = '';
        document.getElementById('addEnglish').value = '';
        document.getElementById('addChinese').focus();
        
        // å¦‚æœå½“å‰æ²¡æœ‰é¢˜ç›®ï¼Œè‡ªåŠ¨ä½¿ç”¨æ–°æ·»åŠ çš„é¢˜ç›®
        if (!currentQuestion) {
            useQuestion(notebook.length - 1);
        }
    }

    function deleteQuestion(index) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™é“é”™é¢˜å—ï¼Ÿ')) {
            const deletedQuestion = notebook[index];
            notebook.splice(index, 1);
            saveNotebook();
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é¢˜ç›®ï¼Œé€‰æ‹©ä¸‹ä¸€é¢˜
            if (currentQuestion && currentQuestion === deletedQuestion) {
                currentQuestion = null;
                nextQuestion();
            }
        }
    }

    function useQuestion(index) {
        if (index >= 0 && index < notebook.length) {
            currentQuestion = notebook[index];
            resetQuestion();
            closeNotebookModal();
        }
    }

    function openAddModal() {
        document.getElementById('addModal').classList.add('show');
        document.getElementById('addChinese').value = '';
        document.getElementById('addEnglish').value = '';
        document.getElementById('addChinese').focus();
    }

    function closeAddModal() {
        document.getElementById('addModal').classList.remove('show');
    }

    function openNotebookModal() {
        showAnswers = false; // é»˜è®¤éšè—ç­”æ¡ˆ
        showStats = false; // é»˜è®¤éšè—ç»Ÿè®¡
        const answerBtn = document.getElementById('toggleAnswerBtn');
        const statsBtn = document.getElementById('toggleStatsBtn');
        if (answerBtn) {
            answerBtn.textContent = 'æ˜¾ç¤ºç­”æ¡ˆ';
        }
        if (statsBtn) {
            statsBtn.textContent = 'æ˜¾ç¤ºç»Ÿè®¡';
        }
        updateNotebookDisplay();
        document.getElementById('notebookModal').classList.add('show');
    }

    function closeNotebookModal() {
        document.getElementById('notebookModal').classList.remove('show');
    }

    // === å¯¼å‡º/å¯¼å…¥åŠŸèƒ½ ===
    function exportNotebook() {
        if (notebook.length === 0) {
            alert('é”™é¢˜æœ¬ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º');
            return;
        }
        
        const dataStr = JSON.stringify(notebook, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `pte_word_notebook_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        // åŒæ—¶å¤åˆ¶åˆ°å‰ªè´´æ¿
        navigator.clipboard.writeText(dataStr).then(() => {
            alert('âœ… é”™é¢˜æœ¬å·²å¯¼å‡ºå¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\næ–‡ä»¶åï¼š' + link.download);
        }).catch(() => {
            alert('âœ… é”™é¢˜æœ¬å·²å¯¼å‡ºï¼\n\næ–‡ä»¶åï¼š' + link.download);
        });
    }

    function importNotebook() {
        // æä¾›ä¸¤ç§æ–¹å¼ï¼šç²˜è´´æ–‡æœ¬æˆ–é€‰æ‹©æ–‡ä»¶
        const useFile = confirm('é€‰æ‹©å¯¼å…¥æ–¹å¼ï¼š\n\nç¡®å®š = é€‰æ‹©æ–‡ä»¶\nå–æ¶ˆ = ç²˜è´´æ–‡æœ¬');
        if (useFile) {
            document.getElementById('fileInput').click();
        } else {
            document.getElementById('importModal').classList.add('show');
            document.getElementById('importData').value = '';
            document.getElementById('importData').focus();
        }
    }

    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (Array.isArray(imported)) {
                    doImportWithData(imported, true);
                } else {
                    alert('âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šå¿…é¡»æ˜¯JSONæ•°ç»„æ ¼å¼');
                }
            } catch (error) {
                alert('âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼š' + error.message);
            }
        };
        reader.readAsText(file);
        // é‡ç½®æ–‡ä»¶è¾“å…¥
        event.target.value = '';
    }

    function doImport() {
        const dataStr = document.getElementById('importData').value.trim();
        if (!dataStr) {
            alert('è¯·è¾“å…¥è¦å¯¼å…¥çš„æ•°æ®');
            return;
        }
        
        try {
            const imported = JSON.parse(dataStr);
            if (!Array.isArray(imported)) {
                alert('âŒ æ•°æ®æ ¼å¼é”™è¯¯ï¼šå¿…é¡»æ˜¯JSONæ•°ç»„æ ¼å¼');
                return;
            }
            
            const merge = document.getElementById('importMerge').checked;
            doImportWithData(imported, merge);
        } catch (error) {
            alert('âŒ æ•°æ®è§£æå¤±è´¥ï¼š' + error.message);
        }
    }

    function doImportWithData(imported, merge) {
        if (merge) {
                // åˆå¹¶æ¨¡å¼ï¼šåˆå¹¶åˆ°ç°æœ‰é”™é¢˜æœ¬
                imported.forEach(item => {
                    if (item.chinese && item.english) {
                        const existingIndex = notebook.findIndex(n => n.chinese === item.chinese);
                        if (existingIndex > -1) {
                            // åˆå¹¶ç­”æ¡ˆ
                            const existing = notebook[existingIndex];
                            const newAnswers = Array.isArray(item.english) ? item.english : [item.english];
                            const existingAnswers = Array.isArray(existing.english) ? existing.english : [existing.english];
                            notebook[existingIndex].english = [...new Set([...existingAnswers, ...newAnswers])];
                            // ä¿ç•™ç°æœ‰çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚æœå¯¼å…¥æ•°æ®æœ‰ç»Ÿè®¡åˆ™åˆå¹¶
                            if (item.correctCount !== undefined) {
                                notebook[existingIndex].correctCount = (notebook[existingIndex].correctCount || 0) + (item.correctCount || 0);
                            }
                            if (item.wrongCount !== undefined) {
                                notebook[existingIndex].wrongCount = (notebook[existingIndex].wrongCount || 0) + (item.wrongCount || 0);
                            }
                        } else {
                            // æ·»åŠ æ–°é¡¹
                            notebook.push({
                                chinese: item.chinese,
                                english: Array.isArray(item.english) ? item.english : [item.english],
                                correctCount: item.correctCount || 0,
                                wrongCount: item.wrongCount || 0
                            });
                        }
                    }
                });
            alert(`âœ… æˆåŠŸå¯¼å…¥å¹¶åˆå¹¶ ${imported.length} æ¡é”™é¢˜è®°å½•ï¼`);
        } else {
            // æ›¿æ¢æ¨¡å¼ï¼šæ¸…ç©ºåå¯¼å…¥
            notebook = imported.map(item => ({
                chinese: item.chinese,
                english: Array.isArray(item.english) ? item.english : [item.english],
                correctCount: item.correctCount || 0,
                wrongCount: item.wrongCount || 0
            }));
            alert(`âœ… æˆåŠŸå¯¼å…¥ ${notebook.length} æ¡é”™é¢˜è®°å½•ï¼ˆå·²æ›¿æ¢åŸæœ‰æ•°æ®ï¼‰ï¼`);
        }
        
        saveNotebook();
        closeImportModal();
        updateNotebookDisplay();
        
        // å¦‚æœå½“å‰æ²¡æœ‰é¢˜ç›®ï¼Œè‡ªåŠ¨å¼€å§‹ç»ƒä¹ 
        if (!currentQuestion && notebook.length > 0) {
            nextQuestion();
        }
    }

    function clearNotebook() {
        if (notebook.length === 0) {
            alert('é”™é¢˜æœ¬å·²ç»æ˜¯ç©ºçš„äº†');
            return;
        }
        
        if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${notebook.length} æ¡é”™é¢˜è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            notebook = [];
            saveNotebook();
            updateNotebookDisplay();
            currentQuestion = null;
            document.getElementById('chineseDisplay').innerText = 'æš‚æ— é¢˜ç›®ï¼Œè¯·å…ˆæ·»åŠ é”™é¢˜';
            document.getElementById('englishInput').disabled = true;
            document.getElementById('checkBtn').disabled = true;
            alert('âœ… é”™é¢˜æœ¬å·²æ¸…ç©º');
        }
    }

    function closeImportModal() {
        document.getElementById('importModal').classList.remove('show');
        document.getElementById('importData').value = '';
    }

    // ç‚¹å‡»å¯¼å…¥æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('importModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeImportModal();
        }
    });

    // === é¢˜ç›®é€»è¾‘ ===
    function nextQuestion() {
        if (notebook.length === 0) {
            document.getElementById('chineseDisplay').innerText = 'æš‚æ— é¢˜ç›®ï¼Œè¯·å…ˆæ·»åŠ é”™é¢˜';
            document.getElementById('englishInput').disabled = true;
            document.getElementById('checkBtn').disabled = true;
            return;
        }
        
        // ä½¿ç”¨åŠ æƒéšæœºé€‰æ‹©é¢˜ç›®
        currentQuestion = selectWeightedQuestion();
        resetQuestion();
    }

    function resetQuestion() {
        isAnswered = false;
        document.getElementById('chineseDisplay').innerText = currentQuestion.chinese;
        document.getElementById('englishInput').value = '';
        document.getElementById('englishInput').disabled = false;
        document.getElementById('englishInput').focus();
        document.getElementById('checkBtn').style.display = 'inline-block';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('feedbackArea').style.display = 'none';
    }

    function checkAnswer() {
        if (isAnswered || !currentQuestion) return;
        
        const userAnswer = document.getElementById('englishInput').value.trim().toLowerCase();
        if (!userAnswer) {
            alert('è¯·è¾“å…¥ç­”æ¡ˆ');
            return;
        }
        
        const correctAnswers = Array.isArray(currentQuestion.english) 
            ? currentQuestion.english 
            : [currentQuestion.english];
        
        const isCorrect = correctAnswers.some(answer => 
            answer.toLowerCase() === userAnswer
        );
        
        // æ›´æ–°æƒé‡ç»Ÿè®¡
        updateQuestionStats(currentQuestion, isCorrect);
        
        showFeedback(isCorrect, userAnswer, correctAnswers);
        isAnswered = true;
        document.getElementById('englishInput').disabled = true;
        document.getElementById('checkBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'inline-block';
        
        // ä¿å­˜æ›´æ–°åçš„ç»Ÿè®¡
        saveNotebook();
    }

    function updateQuestionStats(question, isCorrect) {
        // ç¡®ä¿ç»Ÿè®¡å­—æ®µå­˜åœ¨
        initQuestionStats(question);
        
        if (isCorrect) {
            question.correctCount++;
        } else {
            question.wrongCount++;
        }
    }

    function showFeedback(isCorrect, userAnswer, correctAnswers) {
        const fbBox = document.getElementById('feedbackArea');
        fbBox.style.display = 'block';
        fbBox.className = 'feedback-box ' + (isCorrect ? 'feedback-correct' : 'feedback-wrong');
        
        let html = `<h3>${isCorrect ? 'âœ… å›ç­”æ­£ç¡®!' : 'âŒ å›ç­”é”™è¯¯'}</h3>`;
        html += `<p><strong>ä½ çš„ç­”æ¡ˆ:</strong> "${userAnswer}"</p>`;
        html += `<div class="answers">`;
        html += `<strong>æ­£ç¡®ç­”æ¡ˆ:</strong> `;
        correctAnswers.forEach((answer, index) => {
            html += `<span class="answer-item">${answer}</span>`;
        });
        html += `</div>`;
        
        fbBox.innerHTML = html;
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('addModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeAddModal();
        }
    });

    document.getElementById('notebookModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeNotebookModal();
        }
    });

    // åˆå§‹åŒ–
    window.addEventListener('load', init);
</script>

</body>
</html>

